<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Wiki Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Wiki Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"><title data-react-helmet="true">C1.ç½‘ç»œç¼–ç¨‹ | My Wiki</title><meta data-react-helmet="true" property="og:url" content="https://worst0.github.io/Server/C1.ç½‘ç»œç¼–ç¨‹"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="C1.ç½‘ç»œç¼–ç¨‹ | My Wiki"><meta data-react-helmet="true" name="description" content="- å¤§å®¶ç»å¸¸è¯´çš„å››å±‚ã€ä¸ƒå±‚ï¼Œåˆ†åˆ«æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ"><meta data-react-helmet="true" property="og:description" content="- å¤§å®¶ç»å¸¸è¯´çš„å››å±‚ã€ä¸ƒå±‚ï¼Œåˆ†åˆ«æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ"><meta data-react-helmet="true" property="og:image" content="https://cos.ap-guangzhou.myqcloud.com/wiki-media-1253965369/doc/logo-zip.png"><meta data-react-helmet="true" name="twitter:image" content="https://cos.ap-guangzhou.myqcloud.com/wiki-media-1253965369/doc/logo-zip.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://worst0.github.io/Server/C1.ç½‘ç»œç¼–ç¨‹"><link data-react-helmet="true" rel="alternate" href="https://worst0.github.io/Server/C1.ç½‘ç»œç¼–ç¨‹" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://worst0.github.io/Server/C1.ç½‘ç»œç¼–ç¨‹" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.060912d8.css">
<link rel="preload" href="/assets/js/runtime~main.e07295d6.js" as="script">
<link rel="preload" href="/assets/js/main.acc1624b.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?e("light"):e("dark")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Wiki logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Wiki logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">My Wiki</strong></a><a class="navbar__item navbar__link navbar__link--active" href="/intro">DocumentğŸ’»</a><a class="navbar__item navbar__link" href="/blog">BlogğŸ¤“</a><a class="navbar__item navbar__link" href="/ReadingNotes/A1.Sentence">Reading-BookğŸ“š</a><a class="navbar__item navbar__link" href="/Xmind_IMG/1.è§£é¢˜æ€ç»´">XmindğŸ®</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/worst0/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a href="https://github.com/worst0/wiki_note" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">æœ¬ç«™æºç </a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--checked react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT" style="margin-left:2px">ğŸŒ™</span></div><div class="react-toggle-track-x"><span class="toggle_71bT" style="margin-left:1px">ğŸŒ</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" checked="" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Wiki logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Wiki logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">My Wiki</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/intro">DocumentğŸ’»</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">BlogğŸ¤“</a></li><li class="menu__list-item"><a class="menu__link" href="/ReadingNotes/A1.Sentence">Reading-BookğŸ“š</a></li><li class="menu__list-item"><a class="menu__link" href="/Xmind_IMG/1.è§£é¢˜æ€ç»´">XmindğŸ®</a></li><li class="menu__list-item"><a href="https://github.com/worst0/" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a href="https://github.com/worst0/wiki_note" target="_blank" rel="noopener noreferrer" class="menu__link">æœ¬ç«™æºç </a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">intro</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/intro">Readme</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">1.Linux</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Linux å‘½ä»¤</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Linux/A1.linuxåŸºç¡€">A1.linuxåŸºç¡€</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Linux/A2.Linuxå‘½ä»¤">A2.Linuxå‘½ä»¤</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Linux/A3.ç¼–è¯‘ç¯å¢ƒ">A3.ç¼–è¯‘ç¯å¢ƒ</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Linux/A4.æ•°æ®æå–">æ•°æ®æå–</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Linux/A5.Linuxå‘½ä»¤è¡¥å……">Linuxå‘½ä»¤</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">shellè„šæœ¬</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Linux/B1.shellè„šæœ¬è¯­æ³•">shellè„šæœ¬è¯­æ³•</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">ubuntu</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Linux/C1.ubuntuç›¸å…³">C1.ubuntuç›¸å…³</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Linux/C2.ubuntuå¸¸ç”¨è½¯ä»¶">ubuntuå¸¸ç”¨è½¯ä»¶</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Linux/C3.è¯­è¨€ç¯å¢ƒ">è¯­è¨€ç¯å¢ƒ</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">2.Algorithm</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">æ•°æ®ç»“æ„</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Algorithm/A1.DataStructure">æ•°æ®ç»“æ„å’Œç®—æ³•</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Algorithm/A2.ADT">A2.ADT</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">ç®—æ³•è®¾è®¡</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Algorithm/B1.ç®—æ³•è®¾è®¡">ç®—æ³•è®¾è®¡</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Algorithm/C1.Algorithm">ç®—æ³•</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Algorithm/D1.ACMæ¨¡æ¿">ACMæ¨¡æ¿</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Algorithm/G1.é€»è¾‘æ€è€ƒ">G1.é€»è¾‘æ€è€ƒ</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Algorithm/H1.ç®—æ³•è°œé¢˜">H1.ç®—æ³•è°œé¢˜</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">åŸºç¡€ç§‘å­¦</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Algorithm/E1.concrete">E1.concrete</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Algorithm/E2.Combinatorics">ç»„åˆæ•°å­¦ï¼ˆCombinatoricsï¼‰</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Algorithm/E3.æ•°å­¦è®¤è¯†">è®¤è¯†æ•°å­¦</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Algorithm/F1.ç‰©ç†è®¤è¯†">F1.ç‰©ç†è®¤è¯†</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">3.Online_Judge</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">OJ</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Online_Judge/A1.Leetcode">A1.Leetcode</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Online_Judge/B1.HZOJ">HZOJ</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Online_Judge/C1.nowcoder">nowcoder</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Online_Judge/D1.EP">D1.EP</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">4.Programming_Language</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">C</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Programming_Language/A1.CBasic">A1.CBasic</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Programming_Language/A2.Cimprove">A2.Cimprove</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Programming_Language/A3.Cè¯­è¨€æŠ€å·§">A3.Cè¯­è¨€æŠ€å·§</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">C++</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Programming_Language/B1.C++">B1.C++</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Programming_Language/B3.C++-exercise">C++-exercise</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Programming_Language/B4.C++-others">C++ othres</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">STL</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Programming_Language/C1.STL">STL</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">python</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Programming_Language/D1.python">D1.python</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Programming_Language/E1.conda">E1.conda</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">5.Operating_system</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">æ“ä½œç³»ç»Ÿ</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Operating_system/A1.os">OS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Operating_system/A2.æ“ä½œç³»ç»Ÿ">A2.æ“ä½œç³»ç»Ÿ</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Operating_system/C1.è®¡ç®—æœºåŸç†">C1.è®¡ç®—æœºåŸç†</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Operating_system/D1.CSAPP">D1.CSAPP</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">ç³»ç»Ÿç¼–ç¨‹</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Operating_system/B1.æ–‡ä»¶æ“ä½œ">æ–‡ä»¶æ“ä½œ</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Operating_system/B2.Linuxå‘½ä»¤è¡Œè§£æ">Linuxå‘½ä»¤è¡Œè§£æ</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Operating_system/B3.å¤šè¿›ç¨‹">å¤šè¿›ç¨‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Operating_system/B4.å¤šçº¿ç¨‹">å¤šçº¿ç¨‹çº¿ç¨‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Operating_system/B5.IPC">IPCï¼šè¿›ç¨‹é—´é€šä¿¡</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Operating_system/B6.IO">B6.IO</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Operating_system/B7.mmap">B7.mmap</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Operating_system/B8.socket">B8.socket</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Operating_system/B9.æ–‡ä»¶ä¼ è¾“">B9.æ–‡ä»¶ä¼ è¾“</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Operating_system/B10.IOæ¨¡å‹">B10.IOæ¨¡å‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Operating_system/B11.sleepå’Œé—´éš”è®¡æ—¶å™¨">B11.sleepå’Œé—´éš”è®¡æ—¶å™¨</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">6.Network</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Network/A1.è®¡ç®—æœºç½‘ç»œ">A1.è®¡ç®—æœºç½‘ç»œ</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">7.Server</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Server/A1.Linuxé«˜æ€§èƒ½æœåŠ¡å™¨">Linuxé«˜æ€§èƒ½æœåŠ¡å™¨</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Server/B1.Linuxå¤šçº¿ç¨‹muduo">C++å¤šçº¿ç¨‹ç³»ç»Ÿç¼–ç¨‹</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/Server/C1.ç½‘ç»œç¼–ç¨‹">C1.ç½‘ç»œç¼–ç¨‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Server/D1.å¤šè¿›ç¨‹ç¼–ç¨‹">D1.å¤šè¿›ç¨‹ç¼–ç¨‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/Server/E1.å¤šçº¿ç¨‹ç¼–ç¨‹">E1.å¤šçº¿ç¨‹ç¼–ç¨‹</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">8.Database</a><ul class="menu__list"></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">9.Programming_Stardard</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Programming_Stardard/A1.Cç¼–ç¨‹è§„èŒƒ">A1.Cç¼–ç¨‹è§„èŒƒ</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Programming_Stardard/B1.ç¼–ç è‹±æ–‡ç¼©å†™">B1.ç¼–ç è‹±æ–‡ç¼©å†™</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Programming_Stardard/B2.è‹±æ–‡æ ‡å‡†ç¼©å†™">B2.è‹±æ–‡æ ‡å‡†ç¼©å†™</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Programming_Stardard/C1.é‡æ„">é‡æ„</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Programming_Stardard/D1.Design_Pattern">Design Pattern</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">10.Skill</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Skill/A1.Latexæ•°å­¦å…¬å¼">A1.Latexæ•°å­¦å…¬å¼</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Skill/B1.Markdownè¯­æ³•">B1.Markdownè¯­æ³•</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Skill/C1.git">C1.git</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Skill/C2.github">GitHub</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Skill/D1.è®¡ç®—æœºè‹±è¯­">è®¡ç®—æœºè‹±è¯­</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Skill/E1.ç»˜å›¾">ç»˜å›¾è½¯ä»¶</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">11.Interview</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Interview/A1.é¢è¯•">é¢è¯•</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/Interview/A2.interview">A2.interview</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">99.other</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/other/A1.ä¸´æ—¶">ä¸´æ—¶</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/other/B1.ä¸´æ—¶ç¬”è®°">ä¸´æ—¶ç¬”è®°</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/other/C1.task">task</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/other/D1.è½¯ä»¶éœ€æ±‚">è½¯ä»¶éœ€æ±‚</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/other/E1.software">E1.software</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">C1.ç½‘ç»œç¼–ç¨‹</h1></header><div class="markdown"><ul><li>å¤§å®¶ç»å¸¸è¯´çš„å››å±‚ã€ä¸ƒå±‚ï¼Œåˆ†åˆ«æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>TCP ä¸‰æ¬¡æ¡æ‰‹æ˜¯ä»€ä¹ˆï¼ŒTIME_WAIT æ˜¯æ€ä¹ˆå‘ç”Ÿçš„ï¼ŸCLOSE_WAIT åˆæ˜¯ä»€ä¹ˆçŠ¶æ€ï¼Ÿ</li><li>Linux ä¸‹çš„ epoll è§£å†³çš„æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Ÿå¦‚ä½•ä½¿ç”¨ epoll å†™å‡ºé«˜æ€§èƒ½çš„ç½‘ç»œç¨‹åºï¼Ÿ</li><li>ä»€ä¹ˆæ˜¯ç½‘ç»œäº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼ŸReactor æ¨¡å¼åˆæ˜¯ä»€ä¹ˆï¼Ÿ</li></ul><p><strong>ç¬¬ä¸€å°±æ˜¯ç†è§£ç½‘ç»œåè®®ï¼Œå¹¶åœ¨è¿™ä¸ªåŸºç¡€ä¸Šå’Œæ“ä½œç³»ç»Ÿå†…æ ¸é…åˆï¼Œæ„ŸçŸ¥å„ç§ç½‘ç»œ I/O äº‹ä»¶ï¼›ç¬¬äºŒå°±æ˜¯å­¦ä¼šä½¿ç”¨çº¿ç¨‹å¤„ç†å¹¶å‘</strong>ã€‚</p><p><strong>ç¬¬ä¸€ä¸ªå±‚æ¬¡ï¼Œå……åˆ†ç†è§£ TCP/IP ç½‘ç»œæ¨¡å‹å’Œåè®®</strong>ã€‚</p><p>å¯¹å¥—æ¥å­—ï¼Œå¥—æ¥å­—ç¼“å†²åŒºï¼Œæ‹¥å¡æ§åˆ¶ï¼Œæ•°æ®åŒ…å’Œæ•°æ®æµï¼Œæœ¬åœ°å¥—æ¥å­—ï¼ˆUNIX åŸŸå¥—æ¥å­—ï¼‰ç­‰</p><p><strong>ç¬¬äºŒä¸ªå±‚æ¬¡ï¼Œç»“åˆå¯¹åè®®çš„ç†è§£ï¼Œå¢å¼ºå¯¹å„ç§å¼‚å¸¸æƒ…å†µçš„ä¼˜é›…å¤„ç†èƒ½åŠ›</strong>ã€‚</p><p>æ¯”å¦‚å¯¹ TCP æ•°æ®æµçš„å¤„ç†ï¼ŒåŠå…³é—­çš„è¿æ¥ï¼ŒTCP è¿æ¥æœ‰æ•ˆæ€§çš„ä¾¦æµ‹ï¼Œå¤„ç†å„ç§å¼‚å¸¸æƒ…å†µç­‰ï¼Œè¿™äº›é—®é¢˜å†³å®šäº†ç¨‹åºçš„å¥å£®æ€§ã€‚</p><p><strong>ç¬¬ä¸‰ä¸ªå±‚æ¬¡ï¼Œå†™å‡ºå¯ä»¥æ”¯æŒå¤§è§„æ¨¡é«˜å¹¶å‘çš„ç½‘ç»œå¤„ç†ç¨‹åº</strong></p><p>è¿›ç¨‹ã€çº¿ç¨‹ã€å¤šè·¯å¤ç”¨ã€éé˜»å¡ã€å¼‚æ­¥ã€äº‹ä»¶é©±åŠ¨ç­‰ç°ä»£é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹æ‰€éœ€è¦çš„æŠ€æœ¯ã€‚</p><p><img alt="image-20210909181134965" src="/assets/images/image-20210909181134965-d035be178a8537392a7aece03fd26f54.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ç¬¬5ç« -linuxç½‘ç»œç¼–ç¨‹åŸºç¡€api"></a>ç¬¬5ç«  Linuxç½‘ç»œç¼–ç¨‹åŸºç¡€API<a class="hash-link" href="#ç¬¬5ç« -linuxç½‘ç»œç¼–ç¨‹åŸºç¡€api" title="Direct link to heading">#</a></h2><p>socketåœ°å€APIã€‚socketæœ€å¼€å§‹çš„å«ä¹‰æ˜¯ä¸€ä¸ªIPåœ°å€å’Œç«¯å£å¯¹ï¼ˆipï¼Œportï¼‰</p><p>socketåŸºç¡€APIã€‚socketçš„ä¸»è¦APIéƒ½å®šä¹‰åœ¨sys/socket.hå¤´æ–‡ä»¶ä¸­ï¼ŒåŒ…æ‹¬åˆ›å»ºsocketã€å‘½åsocketã€ç›‘å¬socketã€æ¥å—è¿æ¥ã€å‘èµ·è¿æ¥ã€è¯»å†™æ•°æ®ã€è·å–åœ°å€ä¿¡æ¯ã€æ£€æµ‹å¸¦å¤–æ ‡è®°ï¼Œä»¥åŠè¯»å–å’Œè®¾ç½®socketé€‰é¡¹ã€‚</p><p>ç½‘ç»œä¿¡æ¯APIã€‚Linuxæä¾›äº†ä¸€å¥—ç½‘ç»œä¿¡æ¯APIï¼Œä»¥å®ç°ä¸»æœºåå’ŒIPåœ°å€ä¹‹é—´çš„è½¬æ¢ï¼Œä»¥åŠæœåŠ¡åç§°å’Œç«¯å£å·ä¹‹é—´çš„è½¬æ¢ã€‚è¿™äº›APIéƒ½å®šä¹‰åœ¨netdb.hå¤´æ–‡ä»¶ä¸­</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="socketåœ°å€api"></a>socketåœ°å€API<a class="hash-link" href="#socketåœ°å€api" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ä¸»æœºå­—èŠ‚åºå’Œç½‘ç»œå­—èŠ‚åº"></a>ä¸»æœºå­—èŠ‚åºå’Œç½‘ç»œå­—èŠ‚åº<a class="hash-link" href="#ä¸»æœºå­—èŠ‚åºå’Œç½‘ç»œå­—èŠ‚åº" title="Direct link to heading">#</a></h4><p>ç°ä»£CPUçš„ç´¯åŠ å™¨ä¸€æ¬¡éƒ½èƒ½è£…è½½ï¼ˆè‡³å°‘ï¼‰4å­—èŠ‚ï¼ˆ32ä½è®¡ç®—æœºï¼‰ï¼Œå³ä¸€ä¸ªæ•´æ•°ã€‚é‚£ä¹ˆè¿™4å­—èŠ‚åœ¨å†…å­˜ä¸­æ’åˆ—çš„é¡ºåºå°†å½±å“å®ƒè¢«ç´¯åŠ å™¨è£…è½½æˆçš„æ•´æ•°çš„å€¼ã€‚è¿™å°±æ˜¯å­—èŠ‚åºé—®é¢˜ã€‚</p><p>å­—èŠ‚åºåˆ†ä¸ºå¤§ç«¯å­—èŠ‚åºï¼ˆbig endianï¼‰å’Œå°ç«¯å­—èŠ‚åºï¼ˆlittle endianï¼‰ã€‚å¤§ç«¯å­—èŠ‚åºæ˜¯æŒ‡ä¸€ä¸ªæ•´æ•°çš„é«˜ä½å­—èŠ‚ï¼ˆ23ï½31 bitï¼‰å­˜å‚¨åœ¨å†…å­˜çš„ä½åœ°å€å¤„ï¼Œä½ä½å­—èŠ‚ï¼ˆ0ï½7 bitï¼‰å­˜å‚¨åœ¨å†…å­˜çš„é«˜åœ°å€å¤„ã€‚å°ç«¯å­—èŠ‚åºåˆ™æ˜¯æŒ‡æ•´æ•°çš„é«˜ä½å­—èŠ‚å­˜å‚¨åœ¨å†…å­˜çš„é«˜åœ°å€å¤„ï¼Œè€Œä½ä½å­—èŠ‚åˆ™å­˜å‚¨åœ¨å†…å­˜çš„ä½åœ°å€å¤„ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">main</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> x </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0x12345678</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    cout </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;&lt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0x12</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">?</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;å¤§ç«¯&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;å°ç«¯&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;&lt;</span><span class="token plain"> endl</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">union</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">short</span><span class="token plain"> value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> union_bytes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">short</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> byteOrder</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">main</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    byteOrder</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">value </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0x0102</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">byteOrder</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">union_bytes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">byteOrder</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">union_bytes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;big endian\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">byteOrder</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">union_bytes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">byteOrder</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">union_bytes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;little endian\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;unknown...\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>ç°ä»£PCå¤§å¤šé‡‡ç”¨å°ç«¯å­—èŠ‚åºï¼Œå› æ­¤å°ç«¯å­—èŠ‚åºåˆè¢«ç§°ä¸ºä¸»æœºå­—èŠ‚åºã€‚</p><p>å¤§ç«¯å­—èŠ‚åºä¹Ÿç§°ä¸ºç½‘ç»œå­—èŠ‚åºï¼Œå®ƒç»™æ‰€æœ‰æ¥æ”¶æ•°æ®çš„ä¸»æœºæä¾›äº†ä¸€ä¸ªæ­£ç¡®è§£é‡Šæ”¶åˆ°çš„æ ¼å¼åŒ–æ•°æ®çš„ä¿è¯ã€‚</p><p>å³ä½¿æ˜¯åŒä¸€å°æœºå™¨ä¸Šçš„ä¸¤ä¸ªè¿›ç¨‹ï¼ˆæ¯”å¦‚ä¸€ä¸ªç”±Cè¯­è¨€ç¼–å†™ï¼Œå¦ä¸€ä¸ªç”±JAVAç¼–å†™ï¼‰é€šä¿¡ï¼Œä¹Ÿè¦è€ƒè™‘å­—èŠ‚åºçš„é—®é¢˜</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;netinet/in.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//htonlè¡¨ç¤ºâ€œhost to network longâ€</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//å³å°†é•¿æ•´å‹ï¼ˆ32 bitï¼‰çš„ä¸»æœºå­—èŠ‚åºæ•°æ®è½¬åŒ–ä¸ºç½‘ç»œå­—èŠ‚åºæ•°æ®ã€‚</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//è¿™4ä¸ªå‡½æ•°ä¸­ï¼Œé•¿æ•´å‹å‡½æ•°é€šå¸¸ç”¨æ¥è½¬æ¢IPåœ°å€ï¼ŒçŸ­æ•´å‹å‡½æ•°ç”¨æ¥è½¬æ¢ç«¯å£å·</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">long</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">htonl</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">long</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> hostlong</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">short</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">htons</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">short</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> hostshort</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">long</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">ntohl</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">long</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> netlong</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">short</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">ntohs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">short</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> netshort</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="é€šç”¨socketåœ°å€"></a>é€šç”¨socketåœ°å€<a class="hash-link" href="#é€šç”¨socketåœ°å€" title="Direct link to heading">#</a></h4><p>socketç½‘ç»œç¼–ç¨‹æ¥å£ä¸­è¡¨ç¤ºsocketåœ°å€çš„æ˜¯ç»“æ„ä½“sockaddr</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;bits/socket.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sa_family_t sa_family</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> sa_data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">14</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>sa_familyæˆå‘˜æ˜¯åœ°å€æ—ç±»å‹ï¼ˆsa_family_tï¼‰çš„å˜é‡ã€‚åœ°å€æ—ç±»å‹é€šå¸¸ä¸åè®®æ—ç±»å‹å¯¹åº”ã€‚å¸¸è§çš„åè®®æ—ï¼ˆprotocol familyï¼Œä¹Ÿç§°domainï¼‰å’Œå¯¹åº”çš„åœ°å€æ—</p><p><img alt="image-20210908172043518" src="/assets/images/image-20210908172043518-5cf5e28982afb8da206214781ede4c76.png"></p><p>å®<code>PF_*</code>å’Œ<code>AF_*</code>éƒ½å®šä¹‰åœ¨bits/socket.hå¤´æ–‡ä»¶ä¸­ï¼Œä¸”åè€…ä¸å‰è€…æœ‰å®Œå…¨ç›¸åŒçš„å€¼ï¼Œæ‰€ä»¥äºŒè€…é€šå¸¸æ··ç”¨ã€‚</p><p>sa_dataæˆå‘˜ç”¨äºå­˜æ”¾socketåœ°å€å€¼ã€‚ä½†æ˜¯ï¼Œä¸åŒçš„åè®®æ—çš„åœ°å€å€¼å…·æœ‰ä¸åŒçš„å«ä¹‰å’Œé•¿åº¦ï¼Œ</p><p><img alt="image-20210908172125879" src="/assets/images/image-20210908172125879-a9ed973c5eab83422d094110cfbc6c66.png"></p><p>14å­—èŠ‚çš„sa_dataæ ¹æœ¬æ— æ³•å®Œå…¨å®¹çº³å¤šæ•°åè®®æ—çš„åœ°å€å€¼ã€‚å› æ­¤ï¼ŒLinuxå®šä¹‰äº†ä¸‹é¢è¿™ä¸ªæ–°çš„é€šç”¨socketåœ°å€ç»“æ„ä½“ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;bits/socket.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr_storage</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sa_family_t sa_family</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">long</span><span class="token plain"> int__ss_align</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">char__ss_padding</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">128</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">__ss_align</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>è¿™ä¸ªç»“æ„ä½“ä¸ä»…æä¾›äº†è¶³å¤Ÿå¤§çš„ç©ºé—´ç”¨äºå­˜æ”¾åœ°å€å€¼ï¼Œè€Œä¸”æ˜¯å†…å­˜å¯¹é½çš„ï¼ˆè¿™æ˜¯__ss_alignæˆå‘˜çš„ä½œç”¨ï¼‰ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ä¸“ç”¨socketåœ°å€"></a>ä¸“ç”¨socketåœ°å€<a class="hash-link" href="#ä¸“ç”¨socketåœ°å€" title="Direct link to heading">#</a></h4><p>UNIXæœ¬åœ°åŸŸåè®®æ—ä½¿ç”¨å¦‚ä¸‹ä¸“ç”¨socketåœ°å€ç»“æ„ä½“ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/un.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr_un</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sa_family_t sin_family</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*åœ°å€æ—ï¼šAF_UNIX*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> sun_path</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">108</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*æ–‡ä»¶è·¯å¾„å*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>TCP/IPåè®®æ—æœ‰sockaddr_inå’Œsockaddr_in6ä¸¤ä¸ªä¸“ç”¨socketåœ°å€ç»“æ„ä½“ï¼Œå®ƒä»¬åˆ†åˆ«ç”¨äºIPv4å’ŒIPv6ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr_in</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sa_family_t sin_family</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*åœ°å€æ—ï¼šAF_INET*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">u_int16_t sin_port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*ç«¯å£å·ï¼Œè¦ç”¨ç½‘ç»œå­—èŠ‚åºè¡¨ç¤º*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">in_addr</span><span class="token plain"> sin_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*IPv4åœ°å€ç»“æ„ä½“ï¼Œè§ä¸‹é¢*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">in_addr</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">u_int32_t s_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*IPv4åœ°å€ï¼Œè¦ç”¨ç½‘ç»œå­—èŠ‚åºè¡¨ç¤º*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr_in6</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sa_family_t sin6_family</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*åœ°å€æ—ï¼šAF_INET6*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">u_int16_t sin6_port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*ç«¯å£å·ï¼Œè¦ç”¨ç½‘ç»œå­—èŠ‚åºè¡¨ç¤º*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">u_int32_t sin6_flowinfo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*æµä¿¡æ¯ï¼Œåº”è®¾ç½®ä¸º0*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">in6_addr</span><span class="token plain"> sin6_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*IPv6åœ°å€ç»“æ„ä½“ï¼Œè§ä¸‹é¢*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">u_int32_t sin6_scope_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*scope IDï¼Œå°šå¤„äºå®éªŒé˜¶æ®µ*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">in6_addr</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> sa_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">16</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*IPv6åœ°å€ï¼Œè¦ç”¨ç½‘ç»œå­—èŠ‚åºè¡¨ç¤º*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p><strong>æ‰€æœ‰ä¸“ç”¨socketåœ°å€ï¼ˆä»¥åŠsockaddr_storageï¼‰ç±»å‹çš„å˜é‡åœ¨å®é™…ä½¿ç”¨æ—¶éƒ½éœ€è¦è½¬åŒ–ä¸ºé€šç”¨socketåœ°å€ç±»å‹sockaddrï¼ˆå¼ºåˆ¶è½¬æ¢å³å¯ï¼‰ï¼Œå› ä¸ºæ‰€æœ‰socketç¼–ç¨‹æ¥å£ä½¿ç”¨çš„åœ°å€å‚æ•°çš„ç±»å‹éƒ½æ˜¯sockaddrã€‚</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*åˆ›å»ºä¸€ä¸ªIPv4 socketåœ°å€*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr_in</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">bzero</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ï¼†address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_family </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> AF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_port</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">htons</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">s_addr </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">inet_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;0.0.0.0&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*åˆ›å»ºä¸€ä¸ªIPv4 socketåœ°å€*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">ip</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">argv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">inet_pton</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">AF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ip</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ï¼†address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ipåœ°å€è½¬æ¢å‡½æ•°"></a>IPåœ°å€è½¬æ¢å‡½æ•°<a class="hash-link" href="#ipåœ°å€è½¬æ¢å‡½æ•°" title="Direct link to heading">#</a></h4><p>ç‚¹åˆ†åè¿›åˆ¶å­—ç¬¦ä¸²è¡¨ç¤ºçš„IPv4åœ°å€å’Œç”¨ç½‘ç»œå­—èŠ‚åºæ•´æ•°è¡¨ç¤ºçš„IPv4åœ°å€ä¹‹é—´çš„è½¬æ¢</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;arpa/inet.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//ç‚¹åˆ†åè¿›åˆ¶å­—ç¬¦ä¸²è¡¨ç¤ºçš„IPv4åœ°å€è½¬åŒ–ä¸ºç”¨ç½‘ç»œå­—èŠ‚åºæ•´æ•°è¡¨ç¤ºçš„IPv4åœ°å€ã€‚å®ƒå¤±è´¥æ—¶è¿”å›INADDR_NONEã€‚</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">in_addr_t </span><span class="token function" style="color:rgb(130, 170, 255)">inet_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">strptr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//å°†è½¬åŒ–ç»“æœå­˜å‚¨äºå‚æ•°inpæŒ‡å‘çš„åœ°å€ç»“æ„ä¸­ã€‚å®ƒæˆåŠŸæ—¶è¿”å›1ï¼Œå¤±è´¥åˆ™è¿”å›0ã€‚</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">inet_aton</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">cp</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">in_addr</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">inp</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//å°†ç”¨ç½‘ç»œå­—èŠ‚åºæ•´æ•°è¡¨ç¤ºçš„IPv4åœ°å€è½¬åŒ–ä¸ºç”¨ç‚¹åˆ†åè¿›åˆ¶å­—ç¬¦ä¸²è¡¨ç¤ºçš„IPv4åœ°å€ã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯¥å‡½æ•°å†…éƒ¨ç”¨ä¸€ä¸ªé™æ€å˜é‡å­˜å‚¨è½¬åŒ–ç»“æœï¼Œå‡½æ•°çš„è¿”å›å€¼æŒ‡å‘è¯¥é™æ€å†…å­˜ï¼Œå› æ­¤inet_ntoaæ˜¯ä¸å¯é‡å…¥çš„ã€‚</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token function" style="color:rgb(130, 170, 255)">inet_ntoa</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">in_addr</span><span class="token plain"> in</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p><strong>inet_ntoaæ˜¯ä¸å¯é‡å…¥çš„</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token function" style="color:rgb(130, 170, 255)">my_inet_ntoa</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">in_addr</span><span class="token plain"> in</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">static</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> __ip__</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">uint8_t</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">p </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">uint8_t</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">in</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">s_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">sprintf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">__ip__</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;%d.%d.%d.%d\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> __ip__</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">main</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> input_ip</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">scanf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;%s&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> input_ip</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;input_ip = %s\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> input_ip</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;uint32_t ip = %d\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">inet_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">input_ip</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">in_addr</span><span class="token plain"> in</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    in</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">s_addr </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">inet_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">input_ip</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Ip After Change : %s\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">my_inet_ntoa</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">in</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>ä¸‹é¢è¿™å¯¹æ›´æ–°çš„å‡½æ•°ä¹Ÿèƒ½å®Œæˆå’Œå‰é¢3ä¸ªå‡½æ•°åŒæ ·çš„åŠŸèƒ½ï¼Œå¹¶ä¸”å®ƒä»¬åŒæ—¶é€‚ç”¨äºIPv4åœ°å€å’ŒIPv6åœ°å€ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;arpa/inet.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">inet_pton</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> af</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">src</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">void</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">dst</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token function" style="color:rgb(130, 170, 255)">inet_ntop</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> af</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">void</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">src</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">dst</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">socklen_t cnt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*åˆ›å»ºä¸€ä¸ªIPv4 socketåœ°å€*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">ip</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">argv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr_in</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">bzero</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ï¼†address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_family</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">AF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_port</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">htons</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">inet_pton</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">AF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ip</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ï¼†address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="åˆ›å»ºsocketæŒ‡å®šäº†åœ°å€æ—"></a>åˆ›å»ºsocket:æŒ‡å®šäº†åœ°å€æ—<a class="hash-link" href="#åˆ›å»ºsocketæŒ‡å®šäº†åœ°å€æ—" title="Direct link to heading">#</a></h3><p>UNIX/Linuxçš„ä¸€ä¸ªå“²å­¦æ˜¯ï¼šæ‰€æœ‰ä¸œè¥¿éƒ½æ˜¯æ–‡ä»¶ã€‚socketä¹Ÿä¸ä¾‹å¤–ï¼Œå®ƒå°±æ˜¯å¯è¯»ã€å¯å†™ã€å¯æ§åˆ¶ã€å¯å…³é—­çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/types.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/socket.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> domain</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> protocol</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><table><thead><tr><th></th><th>domain</th><th></th><th>type</th><th></th><th>protocol</th></tr></thead><tbody><tr><td>TCP/IPåè®®æ—</td><td>AF_INET</td><td>TCPåè®®</td><td>SOCK_STREAMï¼ˆæµæœåŠ¡ï¼‰</td><td></td><td>0</td></tr><tr><td>UNIXæœ¬åœ°åŸŸåè®®æ—</td><td>AF_UNIX</td><td>UDPåè®®</td><td>SOCK_UGRAMï¼ˆæ•°æ®æŠ¥ï¼‰</td><td></td><td></td></tr><tr><td></td><td></td><td></td><td>SOCK_NONBLOCK</td><td></td><td></td></tr></tbody></table><p>protocolå‚æ•°æ˜¯åœ¨å‰ä¸¤ä¸ªå‚æ•°æ„æˆçš„åè®®é›†åˆä¸‹ï¼Œå†é€‰æ‹©ä¸€ä¸ªå…·ä½“çš„åè®®ã€‚ä¸è¿‡è¿™ä¸ªå€¼é€šå¸¸éƒ½æ˜¯å”¯ä¸€çš„ï¼ˆå‰ä¸¤ä¸ªå‚æ•°å·²ç»å®Œå…¨å†³å®šäº†å®ƒçš„å€¼ï¼‰ã€‚å‡ ä¹åœ¨æ‰€æœ‰æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½åº”è¯¥æŠŠå®ƒè®¾ç½®ä¸º0ï¼Œè¡¨ç¤ºä½¿ç”¨é»˜è®¤åè®®ã€‚</p><p>socketç³»ç»Ÿè°ƒç”¨æˆåŠŸæ—¶è¿”å›ä¸€ä¸ªsocketæ–‡ä»¶æè¿°ç¬¦ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®errnoã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="å‘½åsocketæŒ‡å®šsocketåœ°å€"></a>å‘½åsocket:æŒ‡å®šsocketåœ°å€<a class="hash-link" href="#å‘½åsocketæŒ‡å®šsocketåœ°å€" title="Direct link to heading">#</a></h3><p>åœ¨æœåŠ¡å™¨ç¨‹åºä¸­ï¼Œé€šå¸¸è¦å‘½åsocketï¼Œå› ä¸ºåªæœ‰å‘½ååå®¢æˆ·ç«¯æ‰èƒ½çŸ¥é“è¯¥å¦‚ä½•è¿æ¥å®ƒã€‚</p><p>å®¢æˆ·ç«¯åˆ™é€šå¸¸ä¸éœ€è¦å‘½åsocketï¼Œè€Œæ˜¯é‡‡ç”¨åŒ¿åæ–¹å¼ï¼Œå³ä½¿ç”¨æ“ä½œç³»ç»Ÿè‡ªåŠ¨åˆ†é…çš„socketåœ°å€ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/types.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/socket.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">bind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">my_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">socklen_t addrlen</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>bindå°†my_addræ‰€æŒ‡çš„socketåœ°å€åˆ†é…ç»™æœªå‘½åçš„sockfdæ–‡ä»¶æè¿°ç¬¦ï¼Œaddrlenå‚æ•°æŒ‡å‡ºè¯¥socketåœ°å€çš„é•¿åº¦ã€‚</p><p>bindæˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®errnoã€‚å…¶ä¸­ä¸¤ç§å¸¸è§çš„errnoæ˜¯EACCESå’ŒEADDRINUSEï¼Œå®ƒä»¬çš„å«ä¹‰åˆ†åˆ«æ˜¯ï¼š</p><ol><li>EACCESï¼Œè¢«ç»‘å®šçš„åœ°å€æ˜¯å—ä¿æŠ¤çš„åœ°å€ï¼Œä»…è¶…çº§ç”¨æˆ·èƒ½å¤Ÿè®¿é—®ã€‚æ¯”å¦‚æ™®é€šç”¨æˆ·å°†socketç»‘å®šåˆ°çŸ¥åæœåŠ¡ç«¯å£ï¼ˆç«¯å£å·ä¸º0ï½1023ï¼‰ä¸Šæ—¶ï¼Œbindå°†è¿”å›EACCESé”™è¯¯ã€‚</li><li>EADDRINUSEï¼Œè¢«ç»‘å®šçš„åœ°å€æ­£åœ¨ä½¿ç”¨ä¸­ã€‚æ¯”å¦‚å°†socketç»‘å®šåˆ°ä¸€ä¸ªå¤„äºTIME_WAITçŠ¶æ€çš„socketåœ°å€ã€‚</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">socket_create</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sockfd </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">AF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> SOCK_STREAM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> val </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">setsockopt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> SOL_SOCKET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> SO_REUSEADDR</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">val</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr_in</span><span class="token plain"> server</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    server</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_family </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> AF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    server</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_port </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">htons</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    server</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">s_addr </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">inet_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;0.0.0.0&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">bind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">server</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">server</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">listen</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ç›‘å¬socket"></a>ç›‘å¬socket<a class="hash-link" href="#ç›‘å¬socket" title="Direct link to heading">#</a></h3><p>åˆ›å»ºä¸€ä¸ªç›‘å¬é˜Ÿåˆ—ä»¥å­˜æ”¾å¾…å¤„ç†çš„å®¢æˆ·è¿æ¥</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/socket.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">listen</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> backlog</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>sockfdå‚æ•°æŒ‡å®šè¢«ç›‘å¬çš„socketã€‚backlogå‚æ•°æç¤ºå†…æ ¸ç›‘å¬é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ã€‚ç›‘å¬é˜Ÿåˆ—çš„é•¿åº¦å¦‚æœè¶…è¿‡backlogï¼ŒæœåŠ¡å™¨å°†ä¸å—ç†æ–°çš„å®¢æˆ·è¿æ¥ï¼Œå®¢æˆ·ç«¯ä¹Ÿå°†æ”¶åˆ°ECONNREFUSEDé”™è¯¯ä¿¡æ¯ã€‚</p><p>åœ¨å†…æ ¸ç‰ˆæœ¬2.2ä¹‹å‰çš„Linuxä¸­ï¼Œbacklogå‚æ•°æ˜¯æŒ‡æ‰€æœ‰å¤„äºåŠè¿æ¥çŠ¶æ€ï¼ˆSYN_RCVDï¼‰å’Œå®Œå…¨è¿æ¥çŠ¶æ€ï¼ˆESTABLISHEDï¼‰çš„socketçš„ä¸Šé™ã€‚</p><p>ä½†è‡ªå†…æ ¸ç‰ˆæœ¬2.2ä¹‹åï¼Œå®ƒåªè¡¨ç¤ºå¤„äºå®Œå…¨è¿æ¥çŠ¶æ€çš„socketçš„ä¸Šé™ï¼Œå¤„äºåŠè¿æ¥çŠ¶æ€çš„socketçš„ä¸Šé™åˆ™ç”±/<code>proc/sys/net/ipv4/tcp_max_syn_backlog</code>å†…æ ¸å‚æ•°å®šä¹‰ã€‚backlogå‚æ•°çš„å…¸å‹å€¼æ˜¯5ã€‚</p><p>listenæˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®errnoã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="æ¥å—è¿æ¥"></a>æ¥å—è¿æ¥<a class="hash-link" href="#æ¥å—è¿æ¥" title="Direct link to heading">#</a></h3><p>ç³»ç»Ÿè°ƒç”¨ä»listenç›‘å¬é˜Ÿåˆ—ä¸­æ¥å—ä¸€ä¸ªè¿æ¥ã€‚</p><p><strong>acceptåªæ˜¯ä»ç›‘å¬é˜Ÿåˆ—ä¸­å–å‡ºè¿æ¥ï¼Œè€Œä¸è®ºè¿æ¥å¤„äºä½•ç§çŠ¶æ€ï¼ˆå¦‚ä¸Šé¢çš„ESTABLISHEDçŠ¶æ€å’ŒCLOSE_WAITçŠ¶æ€ï¼‰ï¼Œæ›´ä¸å…³å¿ƒä»»ä½•ç½‘ç»œçŠ¶å†µçš„å˜åŒ–ã€‚</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/types.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/socket.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">accept</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">socklen_t</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">addrlen</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>sockfdå‚æ•°æ˜¯æ‰§è¡Œè¿‡listenç³»ç»Ÿè°ƒç”¨çš„ç›‘å¬socket ã€‚</p><p>addrå‚æ•°ç”¨æ¥è·å–è¢«æ¥å—è¿æ¥çš„è¿œç«¯socketåœ°å€ï¼Œè¯¥socketåœ°å€çš„é•¿åº¦ç”±addrlenå‚æ•°æŒ‡å‡ºã€‚</p><p>acceptæˆåŠŸæ—¶è¿”å›ä¸€ä¸ªæ–°çš„è¿æ¥socketï¼Œè¯¥socketå”¯ä¸€åœ°æ ‡è¯†äº†è¢«æ¥å—çš„è¿™ä¸ªè¿æ¥ï¼ŒæœåŠ¡å™¨å¯é€šè¿‡è¯»å†™è¯¥socketæ¥ä¸è¢«æ¥å—è¿æ¥å¯¹åº”çš„å®¢æˆ·ç«¯é€šä¿¡ã€‚</p><p>acceptå¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®errnoã€‚</p><blockquote><p>æˆ‘ä»¬æŠŠæ‰§è¡Œè¿‡listenè°ƒç”¨ã€å¤„äºLISTENçŠ¶æ€çš„socketç§°ä¸ºç›‘å¬socketï¼Œè€Œæ‰€æœ‰å¤„äºESTABLISHEDçŠ¶æ€çš„socketåˆ™ç§°ä¸ºè¿æ¥socketã€‚</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="å…³é—­è¿æ¥"></a>å…³é—­è¿æ¥<a class="hash-link" href="#å…³é—­è¿æ¥" title="Direct link to heading">#</a></h3><p>é—­ä¸€ä¸ªè¿æ¥å®é™…ä¸Šå°±æ˜¯å…³é—­è¯¥è¿æ¥å¯¹åº”çš„socket</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;unistd.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">close</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>fdå‚æ•°æ˜¯å¾…å…³é—­çš„socketã€‚ä¸è¿‡ï¼Œcloseç³»ç»Ÿè°ƒç”¨å¹¶éæ€»æ˜¯ç«‹å³å…³é—­ä¸€ä¸ªè¿æ¥ï¼Œè€Œæ˜¯å°†fdçš„å¼•ç”¨è®¡æ•°å‡1ã€‚åªæœ‰å½“fdçš„å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œæ‰çœŸæ­£å…³é—­è¿æ¥ã€‚å¤šè¿›ç¨‹ç¨‹åºä¸­ï¼Œä¸€æ¬¡forkç³»ç»Ÿè°ƒç”¨é»˜è®¤å°†ä½¿çˆ¶è¿›ç¨‹ä¸­æ‰“å¼€çš„socketçš„å¼•ç”¨è®¡æ•°åŠ 1ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»åœ¨çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¸­éƒ½å¯¹è¯¥socketæ‰§è¡Œcloseè°ƒç”¨æ‰èƒ½å°†è¿æ¥å…³é—­ã€‚</p><p>å¦‚æœæ— è®ºå¦‚ä½•éƒ½è¦ç«‹å³ç»ˆæ­¢è¿æ¥ï¼ˆè€Œä¸æ˜¯å°†socketçš„å¼•ç”¨è®¡æ•°å‡1ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„shutdownç³»ç»Ÿè°ƒç”¨ï¼ˆç›¸å¯¹äºcloseæ¥è¯´ï¼Œå®ƒæ˜¯ä¸“é—¨ä¸ºç½‘ç»œç¼–ç¨‹è®¾è®¡çš„ï¼‰ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/socket.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">shutdown</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> howto</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>sockfdå‚æ•°æ˜¯å¾…å…³é—­çš„socketã€‚howtoå‚æ•°å†³å®šäº†shutdownçš„è¡Œä¸º</p><p><img alt="image-20210908175054740" src="/assets/images/image-20210908175054740-2238fe41e973982468dda7c48f2a7514.png"></p><p>ç”±æ­¤å¯è§ï¼Œshutdownèƒ½å¤Ÿåˆ†åˆ«å…³é—­socketä¸Šçš„è¯»æˆ–å†™ï¼Œæˆ–è€…éƒ½å…³é—­ã€‚è€Œcloseåœ¨å…³é—­è¿æ¥æ—¶åªèƒ½å°†socketä¸Šçš„è¯»å’Œå†™åŒæ—¶å…³é—­ã€‚</p><p>shutdownæˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®errnoã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="æ•°æ®è¯»å†™"></a>æ•°æ®è¯»å†™<a class="hash-link" href="#æ•°æ®è¯»å†™" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="tcpæ•°æ®è¯»å†™"></a>TCPæ•°æ®è¯»å†™<a class="hash-link" href="#tcpæ•°æ®è¯»å†™" title="Direct link to heading">#</a></h4><p>å¯¹æ–‡ä»¶çš„è¯»å†™æ“ä½œreadå’ŒwriteåŒæ ·é€‚ç”¨äºsocketã€‚ä½†æ˜¯socketç¼–ç¨‹æ¥å£æä¾›äº†å‡ ä¸ªä¸“é—¨ç”¨äºsocketæ•°æ®è¯»å†™çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒä»¬å¢åŠ äº†å¯¹æ•°æ®è¯»å†™çš„æ§åˆ¶ã€‚å…¶ä¸­ç”¨äºTCPæµæ•°æ®è¯»å†™çš„ç³»ç»Ÿè°ƒç”¨æ˜¯ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/types.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/socket.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ssize_t </span><span class="token function" style="color:rgb(130, 170, 255)">recv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">void</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">buf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">size_t len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> flags</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ssize_t </span><span class="token function" style="color:rgb(130, 170, 255)">send</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">void</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">buf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">size_t len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> flags</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>è¯»å–sockfdä¸Šçš„æ•°æ®ï¼Œbufå’Œlenå‚æ•°åˆ†åˆ«æŒ‡å®šè¯»ç¼“å†²åŒºçš„ä½ç½®å’Œå¤§å°ï¼Œflagså‚æ•°é€šå¸¸è®¾ç½®ä¸º0å³å¯ã€‚recvæˆåŠŸæ—¶è¿”å›å®é™…è¯»å–åˆ°çš„æ•°æ®çš„é•¿åº¦ï¼Œå®ƒå¯èƒ½å°äºæˆ‘ä»¬æœŸæœ›çš„é•¿åº¦lenã€‚å› æ­¤æˆ‘ä»¬å¯èƒ½è¦å¤šæ¬¡è°ƒç”¨recvï¼Œæ‰èƒ½è¯»å–åˆ°å®Œæ•´çš„æ•°æ®ã€‚recvå¯èƒ½è¿”å›0ï¼Œè¿™æ„å‘³ç€é€šä¿¡å¯¹æ–¹å·²ç»å…³é—­è¿æ¥äº†ã€‚recvå‡ºé”™æ—¶è¿”å›-1å¹¶è®¾ç½®errnoã€‚</p><p>sendå¾€sockfdä¸Šå†™å…¥æ•°æ®ï¼Œbufå’Œlenå‚æ•°åˆ†åˆ«æŒ‡å®šå†™ç¼“å†²åŒºçš„ä½ç½®å’Œå¤§å°ã€‚sendæˆåŠŸæ—¶è¿”å›å®é™…å†™å…¥çš„æ•°æ®çš„é•¿åº¦ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®errnoã€‚</p><p>flagså‚æ•°ä¸ºæ•°æ®æ”¶å‘æä¾›äº†é¢å¤–çš„æ§åˆ¶ï¼Œå®ƒå¯ä»¥å–è¡¨æ‰€ç¤ºé€‰é¡¹ä¸­çš„ä¸€ä¸ªæˆ–å‡ ä¸ªçš„é€»è¾‘æˆ–ã€‚åªå¯¹sendå’Œrecvçš„å½“å‰è°ƒç”¨ç”Ÿæ•ˆï¼Œè€Œsetsockoptç³»ç»Ÿè°ƒç”¨æ°¸ä¹…æ€§åœ°ä¿®æ”¹socketçš„æŸäº›å±æ€§ã€‚</p><p><img alt="image-20210908175827923" src="/assets/images/image-20210908175827923-c318d4e6f02d8f8597914aa904968d5d.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="udpæ•°æ®è¯»å†™"></a>UDPæ•°æ®è¯»å†™<a class="hash-link" href="#udpæ•°æ®è¯»å†™" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/types.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/socket.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ssize_t </span><span class="token function" style="color:rgb(130, 170, 255)">recvfrom</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">void</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">buf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">size_t len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> flags</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">src_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">socklen_t</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">addrlen</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ssize_t </span><span class="token function" style="color:rgb(130, 170, 255)">sendto</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">void</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">buf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">size_t len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> flags</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">dest_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">socklen_t addrlen</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>recvfromè¯»å–sockfdä¸Šçš„æ•°æ®ï¼Œbufå’Œlenå‚æ•°åˆ†åˆ«æŒ‡å®šè¯»ç¼“å†²åŒºçš„ä½ç½®å’Œå¤§å°ã€‚å› ä¸ºUDPé€šä¿¡æ²¡æœ‰è¿æ¥çš„æ¦‚å¿µï¼Œæ‰€ä»¥æˆ‘ä»¬æ¯æ¬¡è¯»å–æ•°æ®éƒ½éœ€è¦è·å–å‘é€ç«¯çš„socketåœ°å€ï¼Œå³å‚æ•°src_addræ‰€æŒ‡çš„å†…å®¹ï¼Œaddrlenå‚æ•°åˆ™æŒ‡å®šè¯¥åœ°å€çš„é•¿åº¦ã€‚</p><p>sendtoå¾€sockfdä¸Šå†™å…¥æ•°æ®ï¼Œbufå’Œlenå‚æ•°åˆ†åˆ«æŒ‡å®šå†™ç¼“å†²åŒºçš„ä½ç½®å’Œå¤§å°ã€‚dest_addrå‚æ•°æŒ‡å®šæ¥æ”¶ç«¯çš„socketåœ°å€ï¼Œaddrlenå‚æ•°åˆ™æŒ‡å®šè¯¥åœ°å€çš„é•¿åº¦ã€‚</p><p>recvfrom/sendtoç³»ç»Ÿè°ƒç”¨ä¹Ÿå¯ä»¥ç”¨äºé¢å‘è¿æ¥ï¼ˆSTREAMï¼‰çš„socketçš„æ•°æ®è¯»å†™ï¼Œåªéœ€è¦æŠŠæœ€åä¸¤ä¸ªå‚æ•°éƒ½è®¾ç½®ä¸ºNULLä»¥å¿½ç•¥å‘é€ç«¯/æ¥æ”¶ç«¯çš„socketåœ°å€ï¼ˆå› ä¸ºæˆ‘ä»¬å·²ç»å’Œå¯¹æ–¹å»ºç«‹äº†è¿æ¥ï¼Œæ‰€ä»¥å·²ç»çŸ¥é“å…¶socketåœ°å€äº†ï¼‰ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="é€šç”¨æ•°æ®è¯»å†™å‡½æ•°"></a>é€šç”¨æ•°æ®è¯»å†™å‡½æ•°<a class="hash-link" href="#é€šç”¨æ•°æ®è¯»å†™å‡½æ•°" title="Direct link to heading">#</a></h4><p>é€šç”¨çš„æ•°æ®è¯»å†™ç³»ç»Ÿè°ƒç”¨ã€‚å®ƒä»¬ä¸ä»…èƒ½ç”¨äºTCPæµæ•°æ®ï¼Œä¹Ÿèƒ½ç”¨äºUDPæ•°æ®æŠ¥ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/socket.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ssize_t </span><span class="token function" style="color:rgb(130, 170, 255)">recvmsg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">msghdr</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> flags</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ssize_t </span><span class="token function" style="color:rgb(130, 170, 255)">sendmsg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">msghdr</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> flags</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>sockfdå‚æ•°æŒ‡å®šè¢«æ“ä½œçš„ç›®æ ‡socketã€‚msgå‚æ•°æ˜¯msghdrç»“æ„ä½“ç±»å‹çš„æŒ‡é’ˆï¼Œmsghdrç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">msghdr</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">void</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">msg_name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*socketåœ°å€*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">socklen_t msg_namelen</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*socketåœ°å€çš„é•¿åº¦*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">iovec</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">msg_iov</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*åˆ†æ•£çš„å†…å­˜å—ï¼Œè§åæ–‡*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> msg_iovlen</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*åˆ†æ•£å†…å­˜å—çš„æ•°é‡*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">void</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">msg_control</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*æŒ‡å‘è¾…åŠ©æ•°æ®çš„èµ·å§‹ä½ç½®*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">socklen_t msg_controllen</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*è¾…åŠ©æ•°æ®çš„å¤§å°*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> msg_flags</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å¤åˆ¶å‡½æ•°ä¸­çš„flagså‚æ•°ï¼Œå¹¶åœ¨è°ƒç”¨è¿‡ç¨‹ä¸­æ›´æ–°*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>msg_nameæˆå‘˜æŒ‡å‘ä¸€ä¸ªsocketåœ°å€ç»“æ„å˜é‡ã€‚å®ƒæŒ‡å®šé€šä¿¡å¯¹æ–¹çš„socketåœ°å€ã€‚å¯¹äºé¢å‘è¿æ¥çš„TCPåè®®ï¼Œè¯¥æˆå‘˜æ²¡æœ‰æ„ä¹‰ï¼Œå¿…é¡»è¢«è®¾ç½®ä¸ºNULLã€‚è¿™æ˜¯å› ä¸ºå¯¹æ•°æ®æµsocketè€Œè¨€ï¼Œå¯¹æ–¹çš„åœ°å€å·²ç»çŸ¥é“ã€‚msg_namelenæˆå‘˜åˆ™æŒ‡å®šäº†msg_nameæ‰€æŒ‡socketåœ°å€çš„é•¿åº¦ã€‚</p><p>msg_iovæˆå‘˜æ˜¯iovecç»“æ„ä½“ç±»å‹çš„æŒ‡é’ˆï¼Œiovecç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">iovec</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">void</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">iov_base</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å†…å­˜èµ·å§‹åœ°å€*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">size_t iov_len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*è¿™å—å†…å­˜çš„é•¿åº¦*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>ï¼Œiovecç»“æ„ä½“å°è£…äº†ä¸€å—å†…å­˜çš„èµ·å§‹ä½ç½®å’Œé•¿åº¦ã€‚msg_iovlenæŒ‡å®šè¿™æ ·çš„iovecç»“æ„å¯¹è±¡æœ‰å¤šå°‘ä¸ªã€‚</p><p>å¯¹äºrecvmsgè€Œè¨€ï¼Œæ•°æ®å°†è¢«è¯»å–å¹¶å­˜æ”¾åœ¨msg_iovlenå—åˆ†æ•£çš„å†…å­˜ä¸­ï¼Œè¿™äº›å†…å­˜çš„ä½ç½®å’Œé•¿åº¦åˆ™ç”±msg_iovæŒ‡å‘çš„æ•°ç»„æŒ‡å®šï¼Œè¿™ç§°ä¸ºåˆ†æ•£è¯»ï¼ˆscatter readï¼‰ï¼›</p><p>å¯¹äºsendmsgè€Œè¨€ï¼Œmsg_iovlenå—åˆ†æ•£å†…å­˜ä¸­çš„æ•°æ®å°†è¢«ä¸€å¹¶å‘é€ï¼Œè¿™ç§°ä¸ºé›†ä¸­å†™ï¼ˆgather writeï¼‰ã€‚</p><p>msg_controlå’Œmsg_controllenæˆå‘˜ç”¨äºè¾…åŠ©æ•°æ®çš„ä¼ é€ã€‚æˆ‘ä»¬ä¸è¯¦ç»†è®¨è®ºå®ƒä»¬ï¼Œä»…åœ¨ç¬¬13ç« ä»‹ç»å¦‚ä½•ä½¿ç”¨å®ƒä»¬æ¥å®ç°åœ¨è¿›ç¨‹é—´ä¼ é€’æ–‡ä»¶æè¿°ç¬¦ã€‚</p><p>msg_flagsæˆå‘˜æ— é¡»è®¾å®šï¼Œå®ƒä¼šå¤åˆ¶recvmsg/sendmsgçš„flagså‚æ•°çš„å†…å®¹ä»¥å½±å“æ•°æ®è¯»å†™è¿‡ç¨‹ã€‚recvmsgè¿˜ä¼šåœ¨è°ƒç”¨ç»“æŸå‰ï¼Œå°†æŸäº›æ›´æ–°åçš„æ ‡å¿—è®¾ç½®åˆ°msg_flagsä¸­ã€‚</p><p>recvmsg/sendmsgçš„flagså‚æ•°ä»¥åŠè¿”å›å€¼çš„å«ä¹‰å‡ä¸send/recvçš„flagså‚æ•°åŠè¿”å›å€¼ç›¸åŒã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="å¸¦å¤–æ ‡è®°"></a>å¸¦å¤–æ ‡è®°<a class="hash-link" href="#å¸¦å¤–æ ‡è®°" title="Direct link to heading">#</a></h3><p>got 5 bytes of normal data&#x27;123ab&#x27;</p><p>got 1 bytes of oob data&#x27;c&#x27;</p><p>got 3 bytes of normal data&#x27;123&#x27;</p><hr><p>ç”±æ­¤å¯è§ï¼Œå®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡å™¨çš„3å­—èŠ‚çš„å¸¦å¤–æ•°æ®â€œabcâ€ä¸­ï¼Œä»…æœ‰æœ€åä¸€ä¸ªå­—ç¬¦â€œcâ€è¢«æœåŠ¡å™¨å½“æˆçœŸæ­£çš„å¸¦å¤–æ•°æ®æ¥æ”¶ï¼ˆæ­£å¦‚3.8èŠ‚è®¨è®ºçš„é‚£æ ·ï¼‰ã€‚å¹¶ä¸”ï¼ŒæœåŠ¡å™¨å¯¹æ­£å¸¸æ•°æ®çš„æ¥æ”¶å°†è¢«å¸¦å¤–æ•°æ®æˆªæ–­ï¼Œå³å‰ä¸€éƒ¨åˆ†æ­£å¸¸æ•°æ®â€œ123abâ€å’Œåç»­çš„æ­£å¸¸æ•°æ®â€œ123â€æ˜¯ä¸èƒ½è¢«ä¸€ä¸ªrecvè°ƒç”¨å…¨éƒ¨è¯»å‡ºçš„ã€‚</p><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸æ— æ³•é¢„æœŸå¸¦å¤–æ•°æ®ä½•æ—¶åˆ°æ¥ã€‚</p><p>Linuxå†…æ ¸æ£€æµ‹åˆ°TCPç´§æ€¥æ ‡å¿—æ—¶ï¼Œå°†é€šçŸ¥åº”ç”¨ç¨‹åºæœ‰å¸¦å¤–æ•°æ®éœ€è¦æ¥æ”¶ã€‚å†…æ ¸é€šçŸ¥åº”ç”¨ç¨‹åºå¸¦å¤–æ•°æ®åˆ°è¾¾çš„ä¸¤ç§å¸¸è§æ–¹å¼æ˜¯ï¼šI/Oå¤ç”¨äº§ç”Ÿçš„å¼‚å¸¸äº‹ä»¶å’ŒSIGURGä¿¡å·ã€‚ä½†æ˜¯ï¼Œå³ä½¿åº”ç”¨ç¨‹åºå¾—åˆ°äº†æœ‰å¸¦å¤–æ•°æ®éœ€è¦æ¥æ”¶çš„é€šçŸ¥ï¼Œè¿˜éœ€è¦çŸ¥é“å¸¦å¤–æ•°æ®åœ¨æ•°æ®æµä¸­çš„å…·ä½“ä½ç½®ï¼Œæ‰èƒ½å‡†ç¡®æ¥æ”¶å¸¦å¤–æ•°æ®ã€‚è¿™ä¸€ç‚¹å¯é€šè¿‡å¦‚ä¸‹ç³»ç»Ÿè°ƒç”¨å®ç°ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/socket.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">sockatmark</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>sockatmarkåˆ¤æ–­sockfdæ˜¯å¦å¤„äºå¸¦å¤–æ ‡è®°ï¼Œå³ä¸‹ä¸€ä¸ªè¢«è¯»å–åˆ°çš„æ•°æ®æ˜¯å¦æ˜¯å¸¦å¤–æ•°æ®ã€‚å¦‚æœæ˜¯ï¼Œsockatmarkè¿”å›1ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨å¸¦MSG_OOBæ ‡å¿—çš„recvè°ƒç”¨æ¥æ¥æ”¶å¸¦å¤–æ•°æ®ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™sockatmarkè¿”å›0ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="åœ°å€ä¿¡æ¯å‡½æ•°"></a>åœ°å€ä¿¡æ¯å‡½æ•°<a class="hash-link" href="#åœ°å€ä¿¡æ¯å‡½æ•°" title="Direct link to heading">#</a></h3><p>ä¸€ä¸ªè¿æ¥socketçš„æœ¬ç«¯socketåœ°å€ï¼Œä»¥åŠè¿œç«¯çš„socketåœ°å€ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/socket.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">getsockname</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">socklen_t</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">address_len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">getpeername</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">socklen_t</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">address_len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>getsocknameè·å–sockfdå¯¹åº”çš„æœ¬ç«¯socketåœ°å€ï¼Œå¹¶å°†å…¶å­˜å‚¨äºaddresså‚æ•°æŒ‡å®šçš„å†…å­˜ä¸­ï¼Œè¯¥socketåœ°å€çš„é•¿åº¦åˆ™å­˜å‚¨äºaddress_lenå‚æ•°æŒ‡å‘çš„å˜é‡ä¸­ã€‚å¦‚æœå®é™…socketåœ°å€çš„é•¿åº¦å¤§äºaddressæ‰€æŒ‡å†…å­˜åŒºçš„å¤§å°ï¼Œé‚£ä¹ˆè¯¥socketåœ°å€å°†è¢«æˆªæ–­ã€‚getsocknameæˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥è¿”å›-1å¹¶è®¾ç½®errnoã€‚</p><p>getpeernameè·å–sockfdå¯¹åº”çš„è¿œç«¯socketåœ°å€ï¼Œå…¶å‚æ•°åŠè¿”å›å€¼çš„å«ä¹‰ä¸getsocknameçš„å‚æ•°åŠè¿”å›å€¼ç›¸åŒã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="socketé€‰é¡¹"></a>socketé€‰é¡¹<a class="hash-link" href="#socketé€‰é¡¹" title="Direct link to heading">#</a></h3><p>å¦‚æœè¯´fcntlç³»ç»Ÿè°ƒç”¨æ˜¯æ§åˆ¶æ–‡ä»¶æè¿°ç¬¦å±æ€§çš„é€šç”¨POSIXæ–¹æ³•ï¼Œé‚£ä¹ˆä¸‹é¢ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨åˆ™æ˜¯ä¸“é—¨ç”¨æ¥è¯»å–å’Œè®¾ç½®socketæ–‡ä»¶æè¿°ç¬¦å±æ€§çš„æ–¹æ³•ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/socket.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">getsockopt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> level</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> option_name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">void</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">option_value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">socklen_t</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">restrict option_len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">setsockopt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> level</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> option_name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">void</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">option_value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">socklen_t option_len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>sockfdå‚æ•°æŒ‡å®šè¢«æ“ä½œçš„ç›®æ ‡socketã€‚levelå‚æ•°æŒ‡å®šè¦æ“ä½œå“ªä¸ªåè®®çš„é€‰é¡¹ï¼ˆå³å±æ€§ï¼‰ï¼Œæ¯”å¦‚IPv4ã€IPv6ã€TCPç­‰ã€‚option_nameå‚æ•°åˆ™æŒ‡å®šé€‰é¡¹çš„åå­—ã€‚æˆ‘ä»¬åœ¨è¡¨5-5ä¸­åˆ—ä¸¾äº†socketé€šä¿¡ä¸­å‡ ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„socketé€‰é¡¹ã€‚option_valueå’Œoption_lenå‚æ•°åˆ†åˆ«æ˜¯è¢«æ“ä½œé€‰é¡¹çš„å€¼å’Œé•¿åº¦ã€‚ä¸åŒçš„é€‰é¡¹å…·æœ‰ä¸åŒç±»å‹çš„å€¼</p><p>getsockoptå’Œsetsockoptè¿™ä¸¤ä¸ªå‡½æ•°æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®errnoã€‚</p><p><img alt="image-20210908180910572" src="/assets/images/image-20210908180910572-d6ae5de74addaf8171e50efc02119504.png"></p><p>éƒ¨åˆ†socketé€‰é¡¹åªèƒ½åœ¨è°ƒç”¨listenç³»ç»Ÿè°ƒç”¨å‰é’ˆå¯¹ç›‘å¬socketï¼Œè®¾ç½®æ‰æœ‰æ•ˆã€‚è¿™æ˜¯å› ä¸ºè¿æ¥socketåªèƒ½ç”±acceptè°ƒç”¨è¿”å›ï¼Œè€Œacceptä»listenç›‘å¬é˜Ÿåˆ—ä¸­æ¥å—çš„è¿æ¥è‡³å°‘å·²ç»å®Œæˆäº†TCPä¸‰æ¬¡æ¡æ‰‹çš„å‰ä¸¤ä¸ªæ­¥éª¤ï¼ˆå› ä¸ºlistenç›‘å¬é˜Ÿåˆ—ä¸­çš„è¿æ¥è‡³å°‘å·²è¿›å…¥SYN_RCVDçŠ¶æ€ï¼Œè¯´æ˜æœåŠ¡å™¨å·²ç»å¾€è¢«æ¥å—è¿æ¥ä¸Šå‘é€å‡ºäº†TCPåŒæ­¥æŠ¥æ–‡æ®µã€‚ä½†æœ‰çš„socketé€‰é¡¹å´åº”è¯¥åœ¨TCPåŒæ­¥æŠ¥æ–‡æ®µä¸­è®¾ç½®ï¼Œæ¯”å¦‚TCPæœ€å¤§æŠ¥æ–‡æ®µé€‰é¡¹ï¼ˆå›å¿†3.2.2å°èŠ‚ï¼Œè¯¥é€‰é¡¹åªèƒ½ç”±åŒæ­¥æŠ¥æ–‡æ®µæ¥å‘é€ï¼‰ã€‚</p><p>å¯¹ç›‘å¬socketè®¾ç½®è¿™äº›socketé€‰é¡¹ï¼Œé‚£ä¹ˆacceptè¿”å›çš„è¿æ¥socketå°†è‡ªåŠ¨ç»§æ‰¿è¿™äº›é€‰é¡¹ã€‚è¿™äº›socketé€‰é¡¹åŒ…æ‹¬ï¼šSO_DEBUGã€SO_DONTROUTEã€SO_KEEPALIVEã€SO_LINGERã€SO_OOBINLINEã€SO_RCVBUFã€SO_RCVLOWATã€SO_SNDBUFã€SO_SNDLOWATã€TCP_MAXSEGå’ŒTCP_NODELAYã€‚è€Œå¯¹å®¢æˆ·ç«¯è€Œè¨€ï¼Œè¿™äº›socketé€‰é¡¹åˆ™åº”è¯¥åœ¨è°ƒç”¨connectå‡½æ•°ä¹‹å‰è®¾ç½®ï¼Œå› ä¸ºconnectè°ƒç”¨æˆåŠŸè¿”å›ä¹‹åï¼ŒTCPä¸‰æ¬¡æ¡æ‰‹å·²å®Œæˆã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="so_reuseaddré€‰é¡¹"></a>SO_REUSEADDRé€‰é¡¹<a class="hash-link" href="#so_reuseaddré€‰é¡¹" title="Direct link to heading">#</a></h4><p>è®¾ç½®socketé€‰é¡¹SO_REUSEADDRæ¥å¼ºåˆ¶ä½¿ç”¨è¢«å¤„äºTIME_WAITçŠ¶æ€çš„è¿æ¥å ç”¨çš„socketåœ°å€</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#é‡ç”¨æœ¬åœ°åœ°å€</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sock</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">PF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">SOCK_STREAM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">assert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sock</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> reuse</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">setsockopt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">SOL_SOCKET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">SO_REUSEADDR</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ï¼†reuse</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">reuse</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr_in</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">bzero</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ï¼†address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_family</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">AF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">inet_pton</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">AF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ip</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ï¼†address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_port</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">htons</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> ret</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">bind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">ï¼†address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>é€šè¿‡ä¿®æ”¹å†…æ ¸å‚æ•°<code>/proc/sys/net/ipv4/tcp_tw_recycle</code>æ¥å¿«é€Ÿå›æ”¶è¢«å…³é—­çš„socketï¼Œä»è€Œä½¿å¾—TCPè¿æ¥æ ¹æœ¬å°±ä¸è¿›å…¥TIME_WAITçŠ¶æ€ï¼Œè¿›è€Œå…è®¸åº”ç”¨ç¨‹åºç«‹å³é‡ç”¨æœ¬åœ°çš„socketåœ°å€ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="so_rcvbufå’Œso_sndbufé€‰é¡¹"></a>SO_RCVBUFå’ŒSO_SNDBUFé€‰é¡¹<a class="hash-link" href="#so_rcvbufå’Œso_sndbufé€‰é¡¹" title="Direct link to heading">#</a></h4><p>SO_RCVBUFå’ŒSO_SNDBUFé€‰é¡¹åˆ†åˆ«è¡¨ç¤ºTCPæ¥æ”¶ç¼“å†²åŒºå’Œå‘é€ç¼“å†²åŒºçš„å¤§å°ã€‚</p><p>å½“æˆ‘ä»¬ç”¨setsockoptæ¥è®¾ç½®TCPçš„æ¥æ”¶ç¼“å†²åŒºå’Œå‘é€ç¼“å†²åŒºçš„å¤§å°æ—¶ï¼Œç³»ç»Ÿéƒ½ä¼šå°†å…¶å€¼åŠ å€ï¼Œå¹¶ä¸”ä¸å¾—å°äºæŸä¸ªæœ€å°å€¼ã€‚TCPæ¥æ”¶ç¼“å†²åŒºçš„æœ€å°å€¼æ˜¯256å­—èŠ‚ï¼Œè€Œå‘é€ç¼“å†²åŒºçš„æœ€å°å€¼æ˜¯2048å­—èŠ‚ï¼ˆä¸è¿‡ï¼Œä¸åŒçš„ç³»ç»Ÿå¯èƒ½æœ‰ä¸åŒçš„é»˜è®¤æœ€å°å€¼ï¼‰ã€‚</p><p>ç³»ç»Ÿè¿™æ ·åšçš„ç›®çš„ï¼Œä¸»è¦æ˜¯ç¡®ä¿ä¸€ä¸ªTCPè¿æ¥æ‹¥æœ‰è¶³å¤Ÿçš„ç©ºé—²ç¼“å†²åŒºæ¥å¤„ç†æ‹¥å¡ï¼ˆæ¯”å¦‚å¿«é€Ÿé‡ä¼ ç®—æ³•å°±æœŸæœ›TCPæ¥æ”¶ç¼“å†²åŒºèƒ½è‡³å°‘å®¹çº³4ä¸ªå¤§å°ä¸ºSMSSçš„TCPæŠ¥æ–‡æ®µï¼‰ã€‚</p><p>æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä¿®æ”¹å†…æ ¸å‚æ•°<code>/proc/sys/net/ipv4/tcp_rmem</code>å’Œ<code>proc/sys/net/ipv4/tcp_wmem</code>æ¥å¼ºåˆ¶TCPæ¥æ”¶ç¼“å†²åŒºå’Œå‘é€ç¼“å†²åŒºçš„å¤§å°æ²¡æœ‰æœ€å°å€¼é™åˆ¶ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#ä¿®æ”¹TCPå‘é€ç¼“å†²åŒºçš„å®¢æˆ·ç«¯ç¨‹åº</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">ip</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">argv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> port</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">atoi</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr_in</span><span class="token plain"> server_address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">bzero</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ï¼†server_address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">server_address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">server_address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_family</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">AF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">inet_pton</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">AF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ip</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ï¼†server_address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">server_address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_port</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">htons</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sock</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">PF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">SOCK_STREAM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">assert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sock</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sendbuf</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">atoi</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> len</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sendbuf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å…ˆè®¾ç½®TCPå‘é€ç¼“å†²åŒºçš„å¤§å°ï¼Œç„¶åç«‹å³è¯»å–ä¹‹*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">setsockopt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">SOL_SOCKET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">SO_SNDBUF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ï¼†sendbuf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sendbuf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">getsockopt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">SOL_SOCKET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">SO_SNDBUF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ï¼†sendbuf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">socklen_t</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">ï¼†len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;the tcp send buffer size after setting is%d\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">sendbuf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">connect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">ï¼†server_address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">server_address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">!=</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">BUFFER_SIZE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">memset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">buffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;a&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">BUFFER_SIZE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">send</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">buffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">BUFFER_SIZE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#ä¿®æ”¹TCPæ¥æ”¶ç¼“å†²åŒºçš„æœåŠ¡å™¨ç¨‹åº</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">ip</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">argv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> port</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">atoi</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr_in</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">bzero</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ï¼†address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_family</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">AF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">inet_pton</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">AF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ip</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ï¼†address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_port</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">htons</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sock</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">PF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">SOCK_STREAM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">assert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sock</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> recvbuf</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">atoi</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> len</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">recvbuf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å…ˆè®¾ç½®TCPæ¥æ”¶ç¼“å†²åŒºçš„å¤§å°ï¼Œç„¶åç«‹å³è¯»å–ä¹‹*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">setsockopt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">SOL_SOCKET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">SO_RCVBUF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ï¼†recvbuf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">recvbuf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">getsockopt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">SOL_SOCKET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">SO_RCVBUF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ï¼†recvbuf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">socklen_t</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">ï¼†len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;the tcp receive buffer size after settting is%d\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">recvbuf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> ret</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">bind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">ï¼†address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">assert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ret</span><span class="token operator" style="color:rgb(137, 221, 255)">!=</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ret</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">listen</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">5</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">assert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ret</span><span class="token operator" style="color:rgb(137, 221, 255)">!=</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr_in</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">socklen_t client_addrlength</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">client</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> connfd</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">accept</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">ï¼†client</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ï¼†client_addrlength</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">connfd</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;errno is:%d\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">errno</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">BUFFER_SIZE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">memset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">buffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;\0&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">BUFFER_SIZE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">while</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">recv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">connfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">buffer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">BUFFER_SIZE</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">close</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">connfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">close</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="so_rcvlowatå’Œso_sndlowaté€‰é¡¹"></a>SO_RCVLOWATå’ŒSO_SNDLOWATé€‰é¡¹<a class="hash-link" href="#so_rcvlowatå’Œso_sndlowaté€‰é¡¹" title="Direct link to heading">#</a></h4><p>SO_RCVLOWATå’ŒSO_SNDLOWATé€‰é¡¹åˆ†åˆ«è¡¨ç¤ºTCPæ¥æ”¶ç¼“å†²åŒºå’Œå‘é€ç¼“å†²åŒºçš„ä½æ°´ä½æ ‡è®°ã€‚å®ƒä»¬ä¸€èˆ¬è¢«I/Oå¤ç”¨ç³»ç»Ÿè°ƒç”¨ç”¨æ¥åˆ¤æ–­socketæ˜¯å¦å¯è¯»æˆ–å¯å†™ã€‚</p><p>å½“TCPæ¥æ”¶ç¼“å†²åŒºä¸­å¯è¯»æ•°æ®çš„æ€»æ•°å¤§äºå…¶ä½æ°´ä½æ ‡è®°æ—¶ï¼ŒI/Oå¤ç”¨ç³»ç»Ÿè°ƒç”¨å°†é€šçŸ¥åº”ç”¨ç¨‹åºå¯ä»¥ä»å¯¹åº”çš„socketä¸Šè¯»å–æ•°æ®ï¼›å½“TCPå‘é€ç¼“å†²åŒºä¸­çš„ç©ºé—²ç©ºé—´ï¼ˆå¯ä»¥å†™å…¥æ•°æ®çš„ç©ºé—´ï¼‰å¤§äºå…¶ä½æ°´ä½æ ‡è®°æ—¶ï¼ŒI/Oå¤ç”¨ç³»ç»Ÿè°ƒç”¨å°†é€šçŸ¥åº”ç”¨ç¨‹åºå¯ä»¥å¾€å¯¹åº”çš„sockeä¸Šå†™å…¥æ•°æ®ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒTCPæ¥æ”¶ç¼“å†²åŒºçš„ä½æ°´ä½æ ‡è®°å’ŒTCPå‘é€ç¼“å†²åŒºçš„ä½æ°´ä½æ ‡è®°å‡ä¸º1å­—èŠ‚ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ç½‘ç»œä¿¡æ¯api"></a>ç½‘ç»œä¿¡æ¯API<a class="hash-link" href="#ç½‘ç»œä¿¡æ¯api" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="gethostbynameå’Œgethostbyaddr"></a>gethostbynameå’Œgethostbyaddr<a class="hash-link" href="#gethostbynameå’Œgethostbyaddr" title="Direct link to heading">#</a></h4><p>thostbynameå‡½æ•°æ ¹æ®ä¸»æœºåç§°è·å–ä¸»æœºçš„å®Œæ•´ä¿¡æ¯ï¼Œgethostbyaddrå‡½æ•°æ ¹æ®IPåœ°å€è·å–ä¸»æœºçš„å®Œæ•´ä¿¡æ¯ã€‚</p><p>gethostbynameå‡½æ•°é€šå¸¸å…ˆåœ¨æœ¬åœ°çš„<code>/etc/hosts</code>é…ç½®æ–‡ä»¶ä¸­æŸ¥æ‰¾ä¸»æœºï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå†å»è®¿é—®DNSæœåŠ¡å™¨ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;netdb.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">hostent</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token function" style="color:rgb(130, 170, 255)">gethostbyname</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">hostent</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token function" style="color:rgb(130, 170, 255)">gethostbyaddr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">void</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">size_t len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>nameå‚æ•°æŒ‡å®šç›®æ ‡ä¸»æœºçš„ä¸»æœºåï¼Œaddrå‚æ•°æŒ‡å®šç›®æ ‡ä¸»æœºçš„IPåœ°å€ï¼Œlenå‚æ•°æŒ‡å®šaddræ‰€æŒ‡IPåœ°å€çš„é•¿åº¦ï¼Œtypeå‚æ•°æŒ‡å®šaddræ‰€æŒ‡IPåœ°å€çš„ç±»å‹ï¼Œå…¶åˆæ³•å–å€¼åŒ…æ‹¬AF_INETï¼ˆç”¨äºIPv4åœ°å€ï¼‰å’ŒAF_INET6ï¼ˆç”¨äºIPv6åœ°å€ï¼‰ã€‚</p><p>è¿™ä¸¤ä¸ªå‡½æ•°è¿”å›çš„éƒ½æ˜¯hostentç»“æ„ä½“ç±»å‹çš„æŒ‡é’ˆï¼Œhostentç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;netdb.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">hostent</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">h_name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*ä¸»æœºå*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">h_aliases</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*ä¸»æœºåˆ«ååˆ—è¡¨ï¼Œå¯èƒ½æœ‰å¤šä¸ª*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> h_addrtype</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*åœ°å€ç±»å‹ï¼ˆåœ°å€æ—ï¼‰*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> h_length</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*åœ°å€é•¿åº¦*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">h_addr_list</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*æŒ‰ç½‘ç»œå­—èŠ‚åºåˆ—å‡ºçš„ä¸»æœºIPåœ°å€åˆ—è¡¨*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="getservbynameå’Œgetservbyport"></a>getservbynameå’Œgetservbyport<a class="hash-link" href="#getservbynameå’Œgetservbyport" title="Direct link to heading">#</a></h4><p>getservbynameå‡½æ•°æ ¹æ®åç§°è·å–æŸä¸ªæœåŠ¡çš„å®Œæ•´ä¿¡æ¯ï¼Œgetservbyportå‡½æ•°æ ¹æ®ç«¯å£å·è·å–æŸä¸ªæœåŠ¡çš„å®Œæ•´ä¿¡æ¯ã€‚å®ƒä»¬å®é™…ä¸Šéƒ½æ˜¯é€šè¿‡è¯»å–<code>/etc/services</code>ä»¶æ¥è·å–æœåŠ¡çš„ä¿¡æ¯çš„ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;netdb.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">servent</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token function" style="color:rgb(130, 170, 255)">getservbyname</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">proto</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">servent</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token function" style="color:rgb(130, 170, 255)">getservbyport</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">proto</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>nameå‚æ•°æŒ‡å®šç›®æ ‡æœåŠ¡çš„åå­—ï¼Œportå‚æ•°æŒ‡å®šç›®æ ‡æœåŠ¡å¯¹åº”çš„ç«¯å£å·ã€‚protoå‚æ•°æŒ‡å®šæœåŠ¡ç±»å‹ï¼Œç»™å®ƒä¼ é€’â€œtcpâ€è¡¨ç¤ºè·å–æµæœåŠ¡ï¼Œç»™å®ƒä¼ é€’â€œudpâ€è¡¨ç¤ºè·å–æ•°æ®æŠ¥æœåŠ¡ï¼Œç»™å®ƒä¼ é€’NULLåˆ™è¡¨ç¤ºè·å–æ‰€æœ‰ç±»å‹çš„æœåŠ¡ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ç¬¬9ç« -ioå¤ç”¨"></a>ç¬¬9ç«  I/Oå¤ç”¨<a class="hash-link" href="#ç¬¬9ç« -ioå¤ç”¨" title="Direct link to heading">#</a></h2><p>I/Oå¤ç”¨ä½¿å¾—ç¨‹åºèƒ½åŒæ—¶ç›‘å¬å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä½†å®ƒæœ¬èº«æ˜¯é˜»å¡çš„ã€‚å¹¶ä¸”å½“å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦åŒæ—¶å°±ç»ªæ—¶ï¼Œå¦‚æœä¸é‡‡å–é¢å¤–çš„æªæ–½ï¼Œç¨‹åºå°±åªèƒ½æŒ‰é¡ºåºä¾æ¬¡å¤„ç†å…¶ä¸­çš„æ¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™ä½¿å¾—æœåŠ¡å™¨ç¨‹åºçœ‹èµ·æ¥åƒæ˜¯ä¸²è¡Œå·¥ä½œçš„ã€‚å¦‚æœè¦å®ç°å¹¶å‘ï¼Œåªèƒ½ä½¿ç”¨å¤šè¿›ç¨‹æˆ–å¤šçº¿ç¨‹ç­‰ç¼–ç¨‹æ‰‹æ®µã€‚</p><ul><li>å®¢æˆ·ç«¯ç¨‹åºè¦åŒæ—¶å¤„ç†å¤šä¸ªsocketã€‚æ¯”å¦‚æœ¬ç« å°†è¦è®¨è®ºçš„éé˜»å¡connectæŠ€æœ¯ã€‚</li><li>å®¢æˆ·ç«¯ç¨‹åºè¦åŒæ—¶å¤„ç†ç”¨æˆ·è¾“å…¥å’Œç½‘ç»œè¿æ¥ã€‚æ¯”å¦‚æœ¬ç« å°†è¦è®¨è®ºçš„èŠå¤©å®¤ç¨‹åºã€‚</li><li>TCPæœåŠ¡å™¨è¦åŒæ—¶å¤„ç†ç›‘å¬socketå’Œè¿æ¥socketã€‚è¿™æ˜¯I/Oå¤ç”¨ä½¿ç”¨æœ€å¤šçš„åœºåˆã€‚</li><li>æœåŠ¡å™¨è¦åŒæ—¶å¤„ç†TCPè¯·æ±‚å’ŒUDPè¯·æ±‚ã€‚æ¯”å¦‚æœ¬ç« å°†è¦è®¨è®ºçš„å›å°„æœåŠ¡å™¨ã€‚</li><li>æœåŠ¡å™¨è¦åŒæ—¶ç›‘å¬å¤šä¸ªç«¯å£ï¼Œæˆ–è€…å¤„ç†å¤šç§æœåŠ¡ã€‚æ¯”å¦‚æœ¬ç« å°†è¦è®¨è®ºçš„xinetdæœåŠ¡å™¨ã€‚</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="selectç³»ç»Ÿè°ƒç”¨"></a>selectç³»ç»Ÿè°ƒç”¨<a class="hash-link" href="#selectç³»ç»Ÿè°ƒç”¨" title="Direct link to heading">#</a></h3><p>electç³»ç»Ÿè°ƒç”¨çš„ç”¨é€”æ˜¯ï¼šåœ¨ä¸€æ®µæŒ‡å®šæ—¶é—´å†…ï¼Œç›‘å¬ç”¨æˆ·æ„Ÿå…´è¶£çš„æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„å¯è¯»ã€å¯å†™å’Œå¼‚å¸¸ç­‰äº‹ä»¶ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="select-api"></a>select API<a class="hash-link" href="#select-api" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/select.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">select</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> nfds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> fd_set </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">readfds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> fd_set </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">writefds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> fd_set </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">exceptfds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">timeval</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">timeout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>1ï¼‰nfdså‚æ•°æŒ‡å®šè¢«ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦çš„æ€»æ•°ã€‚å®ƒé€šå¸¸è¢«è®¾ç½®ä¸ºselectç›‘å¬çš„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ä¸­çš„æœ€å¤§å€¼åŠ 1ï¼Œå› ä¸ºæ–‡ä»¶æè¿°ç¬¦æ˜¯ä»0å¼€å§‹è®¡æ•°çš„ã€‚</p><p>2ï¼‰readfdsã€writefdså’Œexceptfdså‚æ•°åˆ†åˆ«æŒ‡å‘å¯è¯»ã€å¯å†™å’Œå¼‚å¸¸ç­‰äº‹ä»¶å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆã€‚</p><p>selectè°ƒç”¨è¿”å›æ—¶ï¼Œå†…æ ¸å°†ä¿®æ”¹å®ƒä»¬æ¥é€šçŸ¥åº”ç”¨ç¨‹åºå“ªäº›æ–‡ä»¶æè¿°ç¬¦å·²ç»å°±ç»ªã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;typesizes.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property expression">__FD_SETSIZE </span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">1024</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/select.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">FD_SETSIZE</span><span class="token macro property"> </span><span class="token macro property expression">__FD_SETSIZE</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">typedef</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">long</span><span class="token plain"> int__fd_mask</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">undef</span><span class="token macro property"> </span><span class="token macro property expression">__NFDBITS</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">__NFDBITS</span><span class="token macro property"> </span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">8</span><span class="token macro property expression operator" style="color:rgb(137, 221, 255)">*</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression keyword" style="font-style:italic">int</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token macro property expression keyword" style="font-style:italic">sizeof</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression">__fd_mask</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">typedef</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/* XPG4.2 requires this member name.  Otherwise avoid the name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">       from the global namespace.  */</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">ifdef</span><span class="token macro property"> </span><span class="token macro property expression">__USE_XOPEN</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    __fd_mask fds_bits</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">__FD_SETSIZE </span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain"> __NFDBITS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property"> </span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name function" style="color:rgb(130, 170, 255)">__FDS_BITS</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression">set</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token macro property expression"> </span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression">set</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token macro property expression operator" style="color:rgb(137, 221, 255)">-&gt;</span><span class="token macro property expression">fds_bits</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">else</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    __fd_mask __fds_bits</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">__FD_SETSIZE </span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain"> __NFDBITS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property"> </span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name function" style="color:rgb(130, 170, 255)">__FDS_BITS</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression">set</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token macro property expression"> </span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression">set</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token macro property expression operator" style="color:rgb(137, 221, 255)">-&gt;</span><span class="token macro property expression">__fds_bits</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">endif</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> fd_set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>fd_setç»“æ„ä½“ä»…åŒ…å«ä¸€ä¸ªæ•´å‹æ•°ç»„ï¼Œè¯¥æ•°ç»„çš„æ¯ä¸ªå…ƒç´ çš„æ¯ä¸€ä½ï¼ˆbitï¼‰æ ‡è®°ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚fd_setèƒ½å®¹çº³çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡ç”±FD_SETSIZEæŒ‡å®šï¼Œè¿™å°±é™åˆ¶äº†selectèƒ½åŒæ—¶å¤„ç†çš„æ–‡ä»¶æè¿°ç¬¦çš„æ€»é‡ã€‚</p><p>ä¸€ç³»åˆ—å®æ¥è®¿é—®fd_setç»“æ„ä½“ä¸­çš„ä½ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/select.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">FD_CLR</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> fd_set </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*æ¸…é™¤fdsetçš„ä½fd*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">FD_ISSET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> fd_set </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*æµ‹è¯•fdsetçš„ä½fdæ˜¯å¦è¢«è®¾ç½®*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">FD_SET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> fd_set </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*è®¾ç½®fdsetçš„ä½fd*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">FD_ZERO</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">fd_set </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*æ¸…é™¤fdsetçš„æ‰€æœ‰ä½*/</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>3ï¼‰timeoutå‚æ•°ç”¨æ¥è®¾ç½®selectå‡½æ•°çš„è¶…æ—¶æ—¶é—´ã€‚å®ƒæ˜¯ä¸€ä¸ªtimevalç»“æ„ç±»å‹çš„æŒ‡é’ˆï¼Œé‡‡ç”¨æŒ‡é’ˆå‚æ•°æ˜¯å› ä¸ºå†…æ ¸å°†ä¿®æ”¹å®ƒä»¥å‘Šè¯‰åº”ç”¨ç¨‹åºselectç­‰å¾…äº†å¤šä¹…ã€‚ä¸è¿‡æˆ‘ä»¬ä¸èƒ½å®Œå…¨ä¿¡ä»»selectè°ƒç”¨è¿”å›åçš„timeoutå€¼ï¼Œæ¯”å¦‚è°ƒç”¨å¤±è´¥æ—¶timeoutå€¼æ˜¯ä¸ç¡®å®šçš„ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">timeval</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">long</span><span class="token plain">    tv_sec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">         </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/* seconds */</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*ç§’æ•°*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">long</span><span class="token plain">    tv_usec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/* microseconds */</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å¾®ç§’æ•°*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>å¦‚æœç»™timeoutå˜é‡çš„tv_secæˆå‘˜å’Œtv_usecæˆå‘˜éƒ½ä¼ é€’0ï¼Œåˆ™selectå°†ç«‹å³è¿”å›ã€‚å¦‚æœç»™timeoutä¼ é€’NULLï¼Œåˆ™selectå°†ä¸€ç›´é˜»å¡ï¼Œç›´åˆ°æŸä¸ªæ–‡ä»¶æè¿°ç¬¦å°±ç»ªã€‚</p><p>selectæˆåŠŸæ—¶è¿”å›å°±ç»ªï¼ˆå¯è¯»ã€å¯å†™å’Œå¼‚å¸¸ï¼‰æ–‡ä»¶æè¿°ç¬¦çš„æ€»æ•°ã€‚å¦‚æœåœ¨è¶…æ—¶æ—¶é—´å†…æ²¡æœ‰ä»»ä½•æ–‡ä»¶æè¿°ç¬¦å°±ç»ªï¼Œselectå°†è¿”å›0ã€‚selectå¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®errnoã€‚å¦‚æœåœ¨selectç­‰å¾…æœŸé—´ï¼Œç¨‹åºæ¥æ”¶åˆ°ä¿¡å·ï¼Œåˆ™selectç«‹å³è¿”å›-1ï¼Œå¹¶è®¾ç½®errnoä¸ºEINTRã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="æ–‡ä»¶æè¿°ç¬¦å°±ç»ªæ¡ä»¶"></a>æ–‡ä»¶æè¿°ç¬¦å°±ç»ªæ¡ä»¶<a class="hash-link" href="#æ–‡ä»¶æè¿°ç¬¦å°±ç»ªæ¡ä»¶" title="Direct link to heading">#</a></h4><p>socketå¯è¯»ï¼š</p><ul><li>socketå†…æ ¸æ¥æ”¶ç¼“å­˜åŒºä¸­çš„å­—èŠ‚æ•°å¤§äºæˆ–ç­‰äºå…¶ä½æ°´ä½æ ‡è®°SO_RCVLOWATã€‚æ­¤æ—¶å¯ä»¥æ— é˜»å¡åœ°è¯»è¯¥socketï¼Œå¹¶ä¸”è¯»æ“ä½œè¿”å›çš„å­—èŠ‚æ•°å¤§äº0ã€‚</li><li>socketé€šä¿¡çš„å¯¹æ–¹å…³é—­è¿æ¥ã€‚è¯»æ“ä½œå°†è¿”å›0ã€‚</li><li>ç›‘å¬socketä¸Šæœ‰æ–°çš„è¿æ¥è¯·æ±‚ã€‚</li><li>socketä¸Šæœ‰æœªå¤„ç†çš„é”™è¯¯ã€‚æ­¤æ—¶å¯ä»¥ä½¿ç”¨getsockoptæ¥è¯»å–å’Œæ¸…é™¤è¯¥é”™è¯¯ã€‚</li></ul><p>ä¸‹åˆ—æƒ…å†µä¸‹socketå¯å†™ï¼š</p><ul><li>socketå†…æ ¸å‘é€ç¼“å­˜åŒºä¸­çš„å¯ç”¨å­—èŠ‚æ•°å¤§äºæˆ–ç­‰äºå…¶ä½æ°´ä½æ ‡è®°SO_SNDLOWATã€‚æ­¤æ—¶å¯ä»¥æ— é˜»å¡åœ°å†™è¯¥socketï¼Œå¹¶ä¸”å†™æ“ä½œè¿”å›çš„å­—èŠ‚æ•°å¤§äº0ã€‚</li><li>socketçš„å†™æ“ä½œè¢«å…³é—­ã€‚å¯¹å†™æ“ä½œè¢«å…³é—­çš„socketæ‰§è¡Œå†™æ“ä½œå°†è§¦å‘ä¸€ä¸ªSIGPIPEä¿¡å·ã€‚</li><li>socketä½¿ç”¨éé˜»å¡connectè¿æ¥æˆåŠŸæˆ–è€…å¤±è´¥ï¼ˆè¶…æ—¶ï¼‰ä¹‹åã€‚</li><li>socketä¸Šæœ‰æœªå¤„ç†çš„é”™è¯¯ã€‚æ­¤æ—¶å¯ä»¥ä½¿ç”¨getsockoptæ¥è¯»å–å’Œæ¸…é™¤è¯¥é”™è¯¯ã€‚</li></ul><p>ç½‘ç»œç¨‹åºä¸­ï¼Œselectèƒ½å¤„ç†çš„å¼‚å¸¸æƒ…å†µåªæœ‰ä¸€ç§ï¼šsocketä¸Šæ¥æ”¶åˆ°å¸¦å¤–æ•°æ®ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="å¤„ç†å¸¦å¤–æ•°æ®"></a>å¤„ç†å¸¦å¤–æ•°æ®<a class="hash-link" href="#å¤„ç†å¸¦å¤–æ•°æ®" title="Direct link to heading">#</a></h4><p>socketä¸Šæ¥æ”¶åˆ°æ™®é€šæ•°æ®å’Œå¸¦å¤–æ•°æ®éƒ½å°†ä½¿selectè¿”å›ï¼Œä½†socketå¤„äºä¸åŒçš„å°±ç»ªçŠ¶æ€ï¼šå‰è€…å¤„äºå¯è¯»çŠ¶æ€ï¼Œåè€…å¤„äºå¼‚å¸¸çŠ¶æ€ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> buf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1024</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fd_set read_fds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fd_set exception_fds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">FD_ZERO</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">read_fds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">FD_ZERO</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">exception_fds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">memset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;\0&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*æ¯æ¬¡è°ƒç”¨selectå‰éƒ½è¦é‡æ–°åœ¨read_fdså’Œexception_fdsä¸­è®¾ç½®æ–‡ä»¶æè¿°ç¬¦connfdï¼Œå› ä¸ºäº‹ä»¶å‘ç”Ÿä¹‹åï¼Œæ–‡ä»¶æè¿°ç¬¦é›†åˆå°†è¢«å†…æ ¸ä¿®æ”¹*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">FD_SET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">connfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">read_fds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">FD_SET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">connfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">exception_fds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ret </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">select</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">connfd </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">read_fds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">exception_fds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token constant" style="color:rgb(130, 170, 255)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ret </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;select failure\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">break</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å¯¹äºå¯è¯»äº‹ä»¶ï¼Œé‡‡ç”¨æ™®é€šçš„recvå‡½æ•°è¯»å–æ•°æ®*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">FD_ISSET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">connfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">read_fds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ret </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">recv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">connfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> buf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ret </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token keyword" style="font-style:italic">break</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å¯¹äºå¼‚å¸¸äº‹ä»¶ï¼Œé‡‡ç”¨å¸¦MSG_OOBæ ‡å¿—çš„recvå‡½æ•°è¯»å–å¸¦å¤–æ•°æ®*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">FD_IS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">connfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">exception_fds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ret </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">recv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">connfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> buf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> MSG_OOB</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ret </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token keyword" style="font-style:italic">break</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;get %d bytes of oob data : %s\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> ret</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> buf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">close</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">connfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">close</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="pollç³»ç»Ÿè°ƒç”¨"></a>pollç³»ç»Ÿè°ƒç”¨<a class="hash-link" href="#pollç³»ç»Ÿè°ƒç”¨" title="Direct link to heading">#</a></h3><p>pollç³»ç»Ÿè°ƒç”¨å’Œselectç±»ä¼¼ï¼Œä¹Ÿæ˜¯åœ¨æŒ‡å®šæ—¶é—´å†…è½®è¯¢ä¸€å®šæ•°é‡çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä»¥æµ‹è¯•å…¶ä¸­æ˜¯å¦æœ‰å°±ç»ªè€…ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property"> </span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;poll.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">poll</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">pollfd</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">fds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> nfds_t nfds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> timeout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">pollfd</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain">   fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">         </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/* file descriptor */</span><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">short</span><span class="token plain"> events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">     </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/* requested events */</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*æ³¨å†Œçš„äº‹ä»¶*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">short</span><span class="token plain"> revents</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/* returned events */</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å®é™…å‘ç”Ÿçš„äº‹ä»¶ï¼Œç”±å†…æ ¸å¡«å……*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>1ï¼‰fdså‚æ•°æ˜¯ä¸€ä¸ªpollfdç»“æ„ç±»å‹çš„æ•°ç»„ï¼Œå®ƒæŒ‡å®šæ‰€æœ‰æˆ‘ä»¬æ„Ÿå…´è¶£çš„æ–‡ä»¶æè¿°ç¬¦ä¸Šå‘ç”Ÿçš„å¯è¯»ã€å¯å†™å’Œå¼‚å¸¸ç­‰äº‹ä»¶ã€‚</p><p><img alt="image-20210909200834042" src="/assets/images/image-20210909200834042-b333ed62f743fd7752a9e986c62079e7.png"></p><p><img alt="image-20210909200846957" src="/assets/images/image-20210909200846957-6657553fbe4b4d5ca752cec0edcbcdab.png"></p><p>é€šå¸¸ï¼Œåº”ç”¨ç¨‹åºéœ€è¦æ ¹æ®recvè°ƒç”¨çš„è¿”å›å€¼æ¥åŒºåˆ†socketä¸Šæ¥æ”¶åˆ°çš„æ˜¯æœ‰æ•ˆæ•°æ®è¿˜æ˜¯å¯¹æ–¹å…³é—­è¿æ¥çš„è¯·æ±‚ï¼Œå¹¶åšç›¸åº”çš„å¤„ç†ã€‚</p><p>è‡ªLinuxå†…æ ¸2.6.17å¼€å§‹ï¼ŒGNUä¸ºpollç³»ç»Ÿè°ƒç”¨å¢åŠ äº†ä¸€ä¸ªPOLLRDHUPäº‹ä»¶ï¼Œå®ƒåœ¨socketä¸Šæ¥æ”¶åˆ°å¯¹æ–¹å…³é—­è¿æ¥çš„è¯·æ±‚ä¹‹åè§¦å‘ã€‚</p><p>è¿™ä¸ºæˆ‘ä»¬åŒºåˆ†ä¸Šè¿°ä¸¤ç§æƒ…å†µæä¾›äº†ä¸€ç§æ›´ç®€å•çš„æ–¹å¼ã€‚ä½†ä½¿ç”¨POLLRDHUPäº‹ä»¶æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä»£ç æœ€å¼€å§‹å¤„å®šä¹‰_GNU_SOURCEã€‚</p><p>2ï¼‰nfdså‚æ•°æŒ‡å®šè¢«ç›‘å¬äº‹ä»¶é›†åˆfdsçš„å¤§å°ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">typedef</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">long</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> nfds_t</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>3ï¼‰timeoutå‚æ•°æŒ‡å®špollçš„è¶…æ—¶å€¼ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚å½“timeoutä¸º-1æ—¶ï¼Œpollè°ƒç”¨å°†æ°¸è¿œé˜»å¡ï¼Œç›´åˆ°æŸä¸ªäº‹ä»¶å‘ç”Ÿï¼›å½“timeoutä¸º0æ—¶ï¼Œpollè°ƒç”¨å°†ç«‹å³è¿”å›ã€‚</p><p>pollç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼çš„å«ä¹‰ä¸selectç›¸åŒã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="epollç³»åˆ—ç³»ç»Ÿè°ƒç”¨"></a>epollç³»åˆ—ç³»ç»Ÿè°ƒç”¨<a class="hash-link" href="#epollç³»åˆ—ç³»ç»Ÿè°ƒç”¨" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="å†…æ ¸äº‹ä»¶è¡¨"></a>å†…æ ¸äº‹ä»¶è¡¨<a class="hash-link" href="#å†…æ ¸äº‹ä»¶è¡¨" title="Direct link to heading">#</a></h4><p>epollæ˜¯Linuxç‰¹æœ‰çš„I/Oå¤ç”¨å‡½æ•°ã€‚</p><p>é¦–å…ˆï¼Œepollä½¿ç”¨ä¸€ç»„å‡½æ•°æ¥å®Œæˆä»»åŠ¡ï¼Œè€Œä¸æ˜¯å•ä¸ªå‡½æ•°ã€‚å…¶æ¬¡ï¼ŒepollæŠŠç”¨æˆ·å…³å¿ƒçš„æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„äº‹ä»¶æ”¾åœ¨å†…æ ¸é‡Œçš„ä¸€ä¸ªäº‹ä»¶è¡¨ä¸­ï¼Œä»è€Œæ— é¡»åƒselectå’Œpollé‚£æ ·æ¯æ¬¡è°ƒç”¨éƒ½è¦é‡å¤ä¼ å…¥æ–‡ä»¶æè¿°ç¬¦é›†æˆ–äº‹ä»¶é›†ã€‚ä½†epolléœ€è¦ä½¿ç”¨ä¸€ä¸ªé¢å¤–çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ¥å”¯ä¸€æ ‡è¯†å†…æ ¸ä¸­çš„è¿™ä¸ªäº‹ä»¶è¡¨ã€‚è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ä½¿ç”¨å¦‚ä¸‹epoll_createå‡½æ•°æ¥åˆ›å»ºï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property"> </span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/epoll.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">epoll_create</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> size</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>sizeå‚æ•°ç°åœ¨å¹¶ä¸èµ·ä½œç”¨ï¼Œåªæ˜¯ç»™å†…æ ¸ä¸€ä¸ªæç¤ºï¼Œå‘Šè¯‰å®ƒäº‹ä»¶è¡¨éœ€è¦å¤šå¤§ã€‚è¯¥å‡½æ•°è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦å°†ç”¨ä½œå…¶ä»–æ‰€æœ‰epollç³»ç»Ÿè°ƒç”¨çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä»¥æŒ‡å®šè¦è®¿é—®çš„å†…æ ¸äº‹ä»¶è¡¨ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">epoll_ctl</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> epfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> op</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">epoll_event</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>fdå‚æ•°æ˜¯è¦æ“ä½œçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œopå‚æ•°åˆ™æŒ‡å®šæ“ä½œç±»å‹ã€‚æ“ä½œç±»å‹æœ‰å¦‚ä¸‹3ç§ï¼š</p><ul><li>EPOLL_CTL_ADDï¼Œå¾€äº‹ä»¶è¡¨ä¸­æ³¨å†Œfdä¸Šçš„äº‹ä»¶ã€‚</li><li>EPOLL_CTL_MODï¼Œä¿®æ”¹fdä¸Šçš„æ³¨å†Œäº‹ä»¶ã€‚</li><li>EPOLL_CTL_DELï¼Œåˆ é™¤fdä¸Šçš„æ³¨å†Œäº‹ä»¶ã€‚</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">epoll_event</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">uint32_t</span><span class="token plain">     events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/* Epoll events */</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    epoll_data_t data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/* User data variable */</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>epollæ”¯æŒçš„äº‹ä»¶ç±»å‹å’ŒpollåŸºæœ¬ç›¸åŒã€‚è¡¨ç¤ºepolläº‹ä»¶ç±»å‹çš„å®æ˜¯åœ¨pollå¯¹åº”çš„å®å‰åŠ ä¸Šâ€œEâ€ã€‚ä½†epollæœ‰ä¸¤ä¸ªé¢å¤–çš„äº‹ä»¶ç±»å‹â€”â€”EPOLLETå’ŒEPOLLONESHOTã€‚å®ƒä»¬å¯¹äºepollçš„é«˜æ•ˆè¿ä½œéå¸¸å…³é”®</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">typedef</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">union</span><span class="token plain"> epoll_data </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">void</span><span class="token plain">        </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">ptr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain">          fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">uint32_t</span><span class="token plain">     u32</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">uint64_t</span><span class="token plain">     u64</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> epoll_data_t</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>epoll_data_tæ˜¯ä¸€ä¸ªè”åˆä½“ï¼Œå…¶4ä¸ªæˆå‘˜ä¸­ä½¿ç”¨æœ€å¤šçš„æ˜¯fdï¼Œå®ƒæŒ‡å®šäº‹ä»¶æ‰€ä»å±çš„ç›®æ ‡æ–‡ä»¶æè¿°ç¬¦ã€‚ptræˆå‘˜å¯ç”¨æ¥æŒ‡å®šä¸fdç›¸å…³çš„ç”¨æˆ·æ•°æ®ã€‚</p><p>epoll_ctlæˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®errnoã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="epoll_waitå‡½æ•°"></a>epoll_waitå‡½æ•°<a class="hash-link" href="#epoll_waitå‡½æ•°" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">epoll_wait</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> epfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">epoll_event</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> maxevents</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> timeout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>è¯¥å‡½æ•°æˆåŠŸæ—¶è¿”å›å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦çš„ä¸ªæ•°ï¼Œå¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®errnoã€‚</p><p>maxeventså‚æ•°æŒ‡å®šæœ€å¤šç›‘å¬å¤šå°‘ä¸ªäº‹ä»¶ï¼Œå®ƒå¿…é¡»å¤§äº0ã€‚</p><p>epoll_waitå‡½æ•°å¦‚æœæ£€æµ‹åˆ°äº‹ä»¶ï¼Œå°±å°†æ‰€æœ‰å°±ç»ªçš„äº‹ä»¶ä»å†…æ ¸äº‹ä»¶è¡¨ï¼ˆç”±epfdå‚æ•°æŒ‡å®šï¼‰ä¸­å¤åˆ¶åˆ°å®ƒçš„ç¬¬äºŒä¸ªå‚æ•°eventsæŒ‡å‘çš„æ•°ç»„ä¸­ã€‚è¿™ä¸ªæ•°ç»„åªç”¨äºè¾“å‡ºepoll_waitæ£€æµ‹åˆ°çš„å°±ç»ªäº‹ä»¶ï¼Œè€Œä¸åƒselectå’Œpollçš„æ•°ç»„å‚æ•°é‚£æ ·æ—¢ç”¨äºä¼ å…¥ç”¨æˆ·æ³¨å†Œçš„äº‹ä»¶ï¼Œåˆç”¨äºè¾“å‡ºå†…æ ¸æ£€æµ‹åˆ°çš„å°±ç»ªäº‹ä»¶ã€‚è¿™å°±æå¤§åœ°æé«˜äº†åº”ç”¨ç¨‹åºç´¢å¼•å°±ç»ªæ–‡ä»¶æè¿°ç¬¦çš„æ•ˆç‡ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å¦‚ä½•ç´¢å¼•pollè¿”å›çš„å°±ç»ªæ–‡ä»¶æè¿°ç¬¦*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> ret</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">poll</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">fds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">MAX_EVENT_NUMBER</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å¿…é¡»éå†æ‰€æœ‰å·²æ³¨å†Œæ–‡ä»¶æè¿°ç¬¦å¹¶æ‰¾åˆ°å…¶ä¸­çš„å°±ç»ªè€…ï¼ˆå½“ç„¶ï¼Œå¯ä»¥åˆ©ç”¨retæ¥ç¨åšä¼˜åŒ–ï¼‰*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">for</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> i</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">iï¼œMAX_EVENT_NUMBER</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token operator" style="color:rgb(137, 221, 255)">++</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">fds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">reventsï¼†POLLIN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*åˆ¤æ–­ç¬¬iä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å°±ç»ª*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">fds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å¤„ç†sockfd*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å¦‚ä½•ç´¢å¼•epollè¿”å›çš„å°±ç»ªæ–‡ä»¶æè¿°ç¬¦*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> ret</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">epoll_wait</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">MAX_EVENT_NUMBER</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*ä»…éå†å°±ç»ªçš„retä¸ªæ–‡ä»¶æè¿°ç¬¦*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">for</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> i</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">iï¼œret</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">i</span><span class="token operator" style="color:rgb(137, 221, 255)">++</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*sockfdè‚¯å®šå°±ç»ªï¼Œç›´æ¥å¤„ç†*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">make_nonblock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> op </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">fcntl</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> F_GETFL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> new_op </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> op </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> O_NONBLOCK</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">fcntl</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> F_SETFL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> new_op</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> op</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">add_event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> enable_et</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">epoll_event</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">fd </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">events </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> EPOLLIN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">enable_et</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">events </span><span class="token operator" style="color:rgb(137, 221, 255)">|=</span><span class="token plain"> EPOLLET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">epoll_ctl</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> EPOLL_CTL_ADD</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">perror</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;epoll_ctl&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">make_nonblock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">main</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">epoll_event</span><span class="token plain"> events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">MAX_EVENT_NUMBER</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">epollfd </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">epoll_create</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">perror</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;epoll_create&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">add_event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> nfds </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">epoll_wait</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> MAX_EVENT_NUMBER</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">nfds </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token function" style="color:rgb(130, 170, 255)">perror</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;epoll_wait&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">break</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> nfds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> i</span><span class="token operator" style="color:rgb(137, 221, 255)">++</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sockfd </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr_in</span><span class="token plain"> client_address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                socklen_t client_addrlength </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr_in</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> connfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">connfd </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">accept</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">client_address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">client_addrlength</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token function" style="color:rgb(130, 170, 255)">perror</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;accept&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token function" style="color:rgb(130, 170, 255)">add_event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> connfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">events </span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain"> EPOLLIN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                pthread_t tid</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                Data new_worker</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                new_worker</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">epollfd </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                new_worker</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sockfd </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token function" style="color:rgb(130, 170, 255)">pthread_create</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">tid</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token constant" style="color:rgb(130, 170, 255)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> do_work</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain">new_worker</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;something else happened\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">close</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">close</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ltå’Œetæ¨¡å¼"></a>LTå’ŒETæ¨¡å¼<a class="hash-link" href="#ltå’Œetæ¨¡å¼" title="Direct link to heading">#</a></h4><p>epollå¯¹æ–‡ä»¶æè¿°ç¬¦çš„æ“ä½œæœ‰ä¸¤ç§æ¨¡å¼ï¼šLTï¼ˆLevel Triggerï¼Œç”µå¹³è§¦å‘ï¼‰æ¨¡å¼å’ŒETï¼ˆEdge Triggerï¼Œè¾¹æ²¿è§¦å‘ï¼‰æ¨¡å¼ã€‚</p><p>LTæ¨¡å¼æ˜¯é»˜è®¤çš„å·¥ä½œæ¨¡å¼ï¼Œè¿™ç§æ¨¡å¼ä¸‹epollç›¸å½“äºä¸€ä¸ªæ•ˆç‡è¾ƒé«˜çš„pollã€‚å½“å¾€epollå†…æ ¸äº‹ä»¶è¡¨ä¸­æ³¨å†Œä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸Šçš„EPOLLETäº‹ä»¶æ—¶ï¼Œepollå°†ä»¥ETæ¨¡å¼æ¥æ“ä½œè¯¥æ–‡ä»¶æè¿°ç¬¦ã€‚ETæ¨¡å¼æ˜¯epollçš„é«˜æ•ˆå·¥ä½œæ¨¡å¼ã€‚</p><p>å¯¹äºé‡‡ç”¨LTå·¥ä½œæ¨¡å¼çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå½“epoll_waitæ£€æµ‹åˆ°å…¶ä¸Šæœ‰äº‹ä»¶å‘ç”Ÿå¹¶å°†æ­¤äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºåï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä¸ç«‹å³å¤„ç†è¯¥äº‹ä»¶ã€‚è¿™æ ·ï¼Œå½“åº”ç”¨ç¨‹åºä¸‹ä¸€æ¬¡è°ƒç”¨epoll_waitæ—¶ï¼Œepoll_waitè¿˜ä¼šå†æ¬¡å‘åº”ç”¨ç¨‹åºé€šå‘Šæ­¤äº‹ä»¶ï¼Œç›´åˆ°è¯¥äº‹ä»¶è¢«å¤„ç†ã€‚</p><p>å¯¹äºé‡‡ç”¨ETå·¥ä½œæ¨¡å¼çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå½“epoll_waitæ£€æµ‹åˆ°å…¶ä¸Šæœ‰äº‹ä»¶å‘ç”Ÿå¹¶å°†æ­¤äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºåï¼Œåº”ç”¨ç¨‹åºå¿…é¡»ç«‹å³å¤„ç†è¯¥äº‹ä»¶ï¼Œå› ä¸ºåç»­çš„epoll_waitè°ƒç”¨å°†ä¸å†å‘åº”ç”¨ç¨‹åºé€šçŸ¥è¿™ä¸€äº‹ä»¶ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">MAX_EVENT_NUMBER</span><span class="token macro property"> </span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">1024</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">BUFFER_SIZE</span><span class="token macro property"> </span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">10</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å°†æ–‡ä»¶æè¿°ç¬¦è®¾ç½®æˆéé˜»å¡çš„*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">setnonblocking</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> old_option</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">fcntl</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">F_GETFL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> new_option</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">old_option</span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">O_NONBLOCK</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">fcntl</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">F_SETFL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">new_option</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> old_option</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å°†æ–‡ä»¶æè¿°ç¬¦fdä¸Šçš„EPOLLINæ³¨å†Œåˆ°epollfdæŒ‡ç¤ºçš„epollå†…æ ¸äº‹ä»¶è¡¨ä¸­ï¼Œå‚æ•°enable_etæŒ‡å®šæ˜¯å¦å¯¹fdå¯ç”¨ETæ¨¡å¼*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">addfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">bool</span><span class="token plain"> enable_et</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    epoll_event event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">fd</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">events</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">EPOLLIN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">enable_et</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">events</span><span class="token operator" style="color:rgb(137, 221, 255)">|=</span><span class="token plain">EPOLLET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">epoll_ctl</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">EPOLL_CTL_ADD</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ï¼†event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">setnonblocking</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*LTæ¨¡å¼çš„å·¥ä½œæµç¨‹*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">lt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">epoll_event</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> buf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">BUFFER_SIZE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">for</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> i</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">iï¼œnumber</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">i</span><span class="token operator" style="color:rgb(137, 221, 255)">++</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sockfd</span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain">listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr_in</span><span class="token plain"> client_address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            socklen_t client_addrlength</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">client_address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> connfd</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">accept</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">ï¼†client_address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                              ï¼†client_addrlength</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token function" style="color:rgb(130, 170, 255)">addfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">connfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token boolean" style="color:rgb(255, 88, 116)">false</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å¯¹connfdç¦ç”¨ETæ¨¡å¼*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">eventsï¼†EPOLLIN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*åªè¦socketè¯»ç¼“å­˜ä¸­è¿˜æœ‰æœªè¯»å‡ºçš„æ•°æ®ï¼Œè¿™æ®µä»£ç å°±è¢«è§¦å‘*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;event trigger once\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token function" style="color:rgb(130, 170, 255)">memset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;\0&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">BUFFER_SIZE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> ret</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">recv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">buf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">BUFFER_SIZE</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">retï¼œ</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token function" style="color:rgb(130, 170, 255)">close</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token keyword" style="font-style:italic">continue</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;get%d bytes of content:%s\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ret</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">buf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;something else happened\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*ETæ¨¡å¼çš„å·¥ä½œæµç¨‹*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">et</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">epoll_event</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> buf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">BUFFER_SIZE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">for</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> i</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">iï¼œnumber</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">i</span><span class="token operator" style="color:rgb(137, 221, 255)">++</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sockfd</span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain">listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr_in</span><span class="token plain"> client_address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            socklen_t client_addrlength</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">client_address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> connfd</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">accept</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">ï¼†client_address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ï¼†client_addrlength</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token function" style="color:rgb(130, 170, 255)">addfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">connfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å¯¹connfdå¼€å¯ETæ¨¡å¼*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">eventsï¼†EPOLLIN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*è¿™æ®µä»£ç ä¸ä¼šè¢«é‡å¤è§¦å‘ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾ªç¯è¯»å–æ•°æ®ï¼Œä»¥ç¡®ä¿æŠŠsocketè¯»ç¼“å­˜ä¸­çš„æ‰€æœ‰æ•°æ®è¯»å‡º*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;event trigger once\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">while</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token function" style="color:rgb(130, 170, 255)">memset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;\0&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">BUFFER_SIZE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> ret</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">recv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">buf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">BUFFER_SIZE</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">retï¼œ</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å¯¹äºéé˜»å¡IOï¼Œä¸‹é¢çš„æ¡ä»¶æˆç«‹è¡¨ç¤ºæ•°æ®å·²ç»å…¨éƒ¨è¯»å–å®Œæ¯•ã€‚æ­¤åï¼Œepollå°±èƒ½å†æ¬¡è§¦å‘sockfdä¸Šçš„EPOLLINäº‹ä»¶ï¼Œä»¥é©±åŠ¨ä¸‹ä¸€æ¬¡è¯»æ“ä½œ*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">errno</span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain">EAGAIN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">||</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">errno</span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain">EWOULDBLOCK</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;read later\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        </span><span class="token keyword" style="font-style:italic">break</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token function" style="color:rgb(130, 170, 255)">close</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token keyword" style="font-style:italic">break</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ret</span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token function" style="color:rgb(130, 170, 255)">close</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sockfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;get%d bytes of content:%s\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ret</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">buf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;something else happened\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">main</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">argcï¼œ</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;usage:%s ip_address port_number\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token function" style="color:rgb(130, 170, 255)">basename</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">ip</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">argv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> port</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">atoi</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> ret</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr_in</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">bzero</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ï¼†address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_family</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">AF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">inet_pton</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">AF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ip</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ï¼†address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_port</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">htons</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> listenfd</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">PF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">SOCK_STREAM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">assert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">listenfdï¼</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ret</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">bind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">ï¼†address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">assert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ret</span><span class="token operator" style="color:rgb(137, 221, 255)">!=</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ret</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">listen</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">5</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">assert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ret</span><span class="token operator" style="color:rgb(137, 221, 255)">!=</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    epoll_event events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">MAX_EVENT_NUMBER</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> epollfd</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">epoll_create</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">5</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">assert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">epollfd</span><span class="token operator" style="color:rgb(137, 221, 255)">!=</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">addfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">while</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> ret</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">epoll_wait</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">MAX_EVENT_NUMBER</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">retï¼œ</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;epoll failure\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">break</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">lt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ret</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*ä½¿ç”¨LTæ¨¡å¼*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//et(events,ret,epollfd,listenfd);/*ä½¿ç”¨ETæ¨¡å¼*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">close</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>æ³¨æ„ï¼šæ¯ä¸ªä½¿ç”¨ETæ¨¡å¼çš„æ–‡ä»¶æè¿°ç¬¦éƒ½åº”è¯¥æ˜¯éé˜»å¡çš„ã€‚å¦‚æœæ–‡ä»¶æè¿°ç¬¦æ˜¯é˜»å¡çš„ï¼Œé‚£ä¹ˆè¯»æˆ–å†™æ“ä½œå°†ä¼šå› ä¸ºæ²¡æœ‰åç»­çš„äº‹ä»¶è€Œä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼ˆé¥¥æ¸´çŠ¶æ€ï¼‰ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="epolloneshotäº‹ä»¶"></a>EPOLLONESHOTäº‹ä»¶<a class="hash-link" href="#epolloneshotäº‹ä»¶" title="Direct link to heading">#</a></h4><p>ä½¿æˆ‘ä»¬ä½¿ç”¨ETæ¨¡å¼ï¼Œä¸€ä¸ªsocketä¸Šçš„æŸä¸ªäº‹ä»¶è¿˜æ˜¯å¯èƒ½è¢«è§¦å‘å¤šæ¬¡ã€‚è¿™åœ¨å¹¶å‘ç¨‹åºä¸­å°±ä¼šå¼•èµ·ä¸€ä¸ªé—®é¢˜ã€‚æ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹ï¼ˆæˆ–è¿›ç¨‹ï¼Œä¸‹åŒï¼‰åœ¨è¯»å–å®ŒæŸä¸ªsocketä¸Šçš„æ•°æ®åå¼€å§‹å¤„ç†è¿™äº›æ•°æ®ï¼Œè€Œåœ¨æ•°æ®çš„å¤„ç†è¿‡ç¨‹ä¸­è¯¥socketä¸Šåˆæœ‰æ–°æ•°æ®å¯è¯»ï¼ˆEPOLLINå†æ¬¡è¢«è§¦å‘ï¼‰ï¼Œæ­¤æ—¶å¦å¤–ä¸€ä¸ªçº¿ç¨‹è¢«å”¤é†’æ¥è¯»å–è¿™äº›æ–°çš„æ•°æ®ã€‚äºæ˜¯å°±å‡ºç°äº†ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œä¸€ä¸ªsocketçš„å±€é¢ã€‚è¿™å½“ç„¶ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„ã€‚æˆ‘ä»¬æœŸæœ›çš„æ˜¯ä¸€ä¸ªsocketè¿æ¥åœ¨ä»»ä¸€æ—¶åˆ»éƒ½åªè¢«ä¸€ä¸ªçº¿ç¨‹å¤„ç†ã€‚</p><p>å¯¹äºæ³¨å†Œäº†EPOLLONESHOTäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ“ä½œç³»ç»Ÿæœ€å¤šè§¦å‘å…¶ä¸Šæ³¨å†Œçš„ä¸€ä¸ªå¯è¯»ã€å¯å†™æˆ–è€…å¼‚å¸¸äº‹ä»¶ï¼Œä¸”åªè§¦å‘ä¸€æ¬¡ï¼Œé™¤éæˆ‘ä»¬ä½¿ç”¨epoll_ctlå‡½æ•°é‡ç½®è¯¥æ–‡ä»¶æè¿°ç¬¦ä¸Šæ³¨å†Œçš„EPOLLONESHOTäº‹ä»¶ã€‚</p><p>è¿™æ ·ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹åœ¨å¤„ç†æŸä¸ªsocketæ—¶ï¼Œå…¶ä»–çº¿ç¨‹æ˜¯ä¸å¯èƒ½æœ‰æœºä¼šæ“ä½œè¯¥socketçš„ã€‚ä½†åè¿‡æ¥æ€è€ƒï¼Œæ³¨å†Œäº†EPOLLONESHOTäº‹ä»¶çš„socketä¸€æ—¦è¢«æŸä¸ªçº¿ç¨‹å¤„ç†å®Œæ¯•ï¼Œè¯¥çº¿ç¨‹å°±åº”è¯¥ç«‹å³é‡ç½®è¿™ä¸ªsocketä¸Šçš„EPOLLONESHOTäº‹ä»¶ï¼Œä»¥ç¡®ä¿è¿™ä¸ªsocketä¸‹ä¸€æ¬¡å¯è¯»æ—¶ï¼Œå…¶EPOLLINäº‹ä»¶èƒ½è¢«è§¦å‘ï¼Œè¿›è€Œè®©å…¶ä»–å·¥ä½œçº¿ç¨‹æœ‰æœºä¼šç»§ç»­å¤„ç†è¿™ä¸ªsocketã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ä¸‰ç»„ioå¤ç”¨å‡½æ•°çš„æ¯”è¾ƒ"></a>ä¸‰ç»„I/Oå¤ç”¨å‡½æ•°çš„æ¯”è¾ƒ<a class="hash-link" href="#ä¸‰ç»„ioå¤ç”¨å‡½æ•°çš„æ¯”è¾ƒ" title="Direct link to heading">#</a></h3><p>selectã€pollå’Œepollä¸‰ç»„I/Oå¤ç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™3ç»„ç³»ç»Ÿè°ƒç”¨éƒ½èƒ½åŒæ—¶ç›‘å¬å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚å®ƒä»¬å°†ç­‰å¾…ç”±timeoutå‚æ•°æŒ‡å®šçš„è¶…æ—¶æ—¶é—´ï¼Œç›´åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸Šæœ‰äº‹ä»¶å‘ç”Ÿæ—¶è¿”å›ï¼Œè¿”å›å€¼æ˜¯å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ã€‚è¿”å›0è¡¨ç¤ºæ²¡æœ‰äº‹ä»¶å‘ç”Ÿã€‚</p><p>äº‹ä»¶é›†ã€æœ€å¤§æ”¯æŒæ–‡ä»¶æè¿°ç¬¦æ•°ã€å·¥ä½œæ¨¡å¼å’Œå…·ä½“å®ç°ç­‰å››ä¸ªæ–¹é¢è¿›ä¸€æ­¥æ¯”è¾ƒå®ƒä»¬çš„å¼‚åŒ</p><p>3ç»„å‡½æ•°éƒ½é€šè¿‡æŸç§ç»“æ„ä½“å˜é‡æ¥å‘Šè¯‰å†…æ ¸ç›‘å¬å“ªäº›æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„å“ªäº›äº‹ä»¶ï¼Œå¹¶ä½¿ç”¨è¯¥ç»“æ„ä½“ç±»å‹çš„å‚æ•°æ¥è·å–å†…æ ¸å¤„ç†çš„ç»“æœã€‚</p><p>selectçš„å‚æ•°ç±»å‹fd_setæ²¡æœ‰å°†æ–‡ä»¶æè¿°ç¬¦å’Œäº‹ä»¶ç»‘å®šï¼Œå®ƒä»…ä»…æ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œå› æ­¤selectéœ€è¦æä¾›3ä¸ªè¿™ç§ç±»å‹çš„å‚æ•°æ¥åˆ†åˆ«ä¼ å…¥å’Œè¾“å‡ºå¯è¯»ã€å¯å†™åŠå¼‚å¸¸ç­‰äº‹ä»¶ã€‚è¿™ä¸€æ–¹é¢ä½¿å¾—selectä¸èƒ½å¤„ç†æ›´å¤šç±»å‹çš„äº‹ä»¶ï¼Œå¦ä¸€æ–¹é¢ç”±äºå†…æ ¸å¯¹fd_seté›†åˆçš„åœ¨çº¿ä¿®æ”¹ï¼Œåº”ç”¨ç¨‹åºä¸‹æ¬¡è°ƒç”¨selectå‰ä¸å¾—ä¸é‡ç½®è¿™3ä¸ªfd_seté›†åˆã€‚</p><p>pollfdå®ƒæŠŠæ–‡ä»¶æè¿°ç¬¦å’Œäº‹ä»¶éƒ½å®šä¹‰å…¶ä¸­ï¼Œä»»ä½•äº‹ä»¶éƒ½è¢«ç»Ÿä¸€å¤„ç†ï¼Œä»è€Œä½¿å¾—ç¼–ç¨‹æ¥å£ç®€æ´å¾—å¤šã€‚å¹¶ä¸”å†…æ ¸æ¯æ¬¡ä¿®æ”¹çš„æ˜¯pollfdç»“æ„ä½“çš„reventsæˆå‘˜ï¼Œè€Œeventsæˆå‘˜ä¿æŒä¸å˜ï¼Œå› æ­¤ä¸‹æ¬¡è°ƒç”¨pollæ—¶åº”ç”¨ç¨‹åºæ— é¡»é‡ç½®pollfdç±»å‹çš„äº‹ä»¶é›†å‚æ•°ã€‚</p><p>ç”±äºæ¯æ¬¡selectå’Œpollè°ƒç”¨éƒ½è¿”å›æ•´ä¸ªç”¨æˆ·æ³¨å†Œçš„äº‹ä»¶é›†åˆï¼ˆå…¶ä¸­åŒ…æ‹¬å°±ç»ªçš„å’Œæœªå°±ç»ªçš„ï¼‰ï¼Œæ‰€ä»¥åº”ç”¨ç¨‹åºç´¢å¼•å°±ç»ªæ–‡ä»¶æè¿°ç¬¦çš„æ—¶é—´å¤æ‚åº¦ä¸ºOï¼ˆnï¼‰ã€‚</p><p>epollå®ƒåœ¨å†…æ ¸ä¸­ç»´æŠ¤ä¸€ä¸ªäº‹ä»¶è¡¨ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªç‹¬ç«‹çš„ç³»ç»Ÿè°ƒç”¨epoll_ctlæ¥æ§åˆ¶å¾€å…¶ä¸­æ·»åŠ ã€åˆ é™¤ã€ä¿®æ”¹äº‹ä»¶ã€‚è¿™æ ·ï¼Œæ¯æ¬¡epoll_waitè°ƒç”¨éƒ½ç›´æ¥ä»è¯¥å†…æ ¸äº‹ä»¶è¡¨ä¸­å–å¾—ç”¨æˆ·æ³¨å†Œçš„äº‹ä»¶ï¼Œè€Œæ— é¡»åå¤ä»ç”¨æˆ·ç©ºé—´è¯»å…¥è¿™äº›äº‹ä»¶ã€‚epoll_waitç³»ç»Ÿè°ƒç”¨çš„eventså‚æ•°ä»…ç”¨æ¥è¿”å›å°±ç»ªçš„äº‹ä»¶ï¼Œè¿™ä½¿å¾—åº”ç”¨ç¨‹åºç´¢å¼•å°±ç»ªæ–‡ä»¶æè¿°ç¬¦çš„æ—¶é—´å¤æ‚åº¦è¾¾åˆ°Oï¼ˆ1ï¼‰ã€‚</p><p>pollå’Œepoll_waitåˆ†åˆ«ç”¨nfdså’Œmaxeventså‚æ•°æŒ‡å®šæœ€å¤šç›‘å¬å¤šå°‘ä¸ªæ–‡ä»¶æè¿°ç¬¦å’Œäº‹ä»¶ã€‚è¿™ä¸¤ä¸ªæ•°å€¼éƒ½èƒ½è¾¾åˆ°ç³»ç»Ÿå…è®¸æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°ç›®ï¼Œå³65 535ï¼ˆcat/proc/sys/fs/file-maxï¼‰ã€‚è€Œselectå…è®¸ç›‘å¬çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°é‡é€šå¸¸æœ‰é™åˆ¶ã€‚è™½ç„¶ç”¨æˆ·å¯ä»¥ä¿®æ”¹è¿™ä¸ªé™åˆ¶ï¼Œä½†è¿™å¯èƒ½å¯¼è‡´ä¸å¯é¢„æœŸçš„åæœã€‚</p><p>selectå’Œpolléƒ½åªèƒ½å·¥ä½œåœ¨ç›¸å¯¹ä½æ•ˆçš„LTæ¨¡å¼ï¼Œè€Œepollåˆ™å¯ä»¥å·¥ä½œåœ¨ETé«˜æ•ˆæ¨¡å¼ã€‚å¹¶ä¸”epollè¿˜æ”¯æŒEPOLLONESHOTäº‹ä»¶ã€‚è¯¥äº‹ä»¶èƒ½è¿›ä¸€æ­¥å‡å°‘å¯è¯»ã€å¯å†™å’Œå¼‚å¸¸ç­‰äº‹ä»¶è¢«è§¦å‘çš„æ¬¡æ•°ã€‚</p><p>ä»å®ç°åŸç†ä¸Šæ¥è¯´ï¼Œselectå’Œpollé‡‡ç”¨çš„éƒ½æ˜¯è½®è¯¢çš„æ–¹å¼ï¼Œå³æ¯æ¬¡è°ƒç”¨éƒ½è¦æ‰«ææ•´ä¸ªæ³¨å†Œæ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œå¹¶å°†å…¶ä¸­å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦è¿”å›ç»™ç”¨æˆ·ç¨‹åºï¼Œå› æ­¤å®ƒä»¬æ£€æµ‹å°±ç»ªäº‹ä»¶çš„ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦æ˜¯Oï¼ˆnï¼‰ã€‚epoll_waitåˆ™ä¸åŒï¼Œå®ƒé‡‡ç”¨çš„æ˜¯å›è°ƒçš„æ–¹å¼ã€‚å†…æ ¸æ£€æµ‹åˆ°å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦æ—¶ï¼Œå°†è§¦å‘å›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°å°±å°†è¯¥æ–‡ä»¶æè¿°ç¬¦ä¸Šå¯¹åº”çš„äº‹ä»¶æ’å…¥å†…æ ¸å°±ç»ªäº‹ä»¶é˜Ÿåˆ—ã€‚å†…æ ¸æœ€ååœ¨é€‚å½“çš„æ—¶æœºå°†è¯¥å°±ç»ªäº‹ä»¶é˜Ÿåˆ—ä¸­çš„å†…å®¹æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚å› æ­¤epoll_waitæ— é¡»è½®è¯¢æ•´ä¸ªæ–‡ä»¶æè¿°ç¬¦é›†åˆæ¥æ£€æµ‹å“ªäº›äº‹ä»¶å·²ç»å°±ç»ªï¼Œå…¶ç®—æ³•æ—¶é—´å¤æ‚åº¦æ˜¯Oï¼ˆ1ï¼‰ã€‚ä½†æ˜¯ï¼Œå½“æ´»åŠ¨è¿æ¥æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œepoll_waitçš„æ•ˆç‡æœªå¿…æ¯”selectå’Œpollé«˜ï¼Œå› ä¸ºæ­¤æ—¶å›è°ƒå‡½æ•°è¢«è§¦å‘å¾—è¿‡äºé¢‘ç¹ã€‚æ‰€ä»¥epoll_waité€‚ç”¨äºè¿æ¥æ•°é‡å¤šï¼Œä½†æ´»åŠ¨è¿æ¥è¾ƒå°‘çš„æƒ…å†µ</p><p><img alt="image-20210909210909099" src="/assets/images/image-20210909210909099-3f9652e523ce95836e1e98cf5f25f647.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ç¬¬10ç« -ä¿¡å·"></a>ç¬¬10ç«  ä¿¡å·<a class="hash-link" href="#ç¬¬10ç« -ä¿¡å·" title="Direct link to heading">#</a></h2><p>ä¿¡å·æ˜¯ç”±ç”¨æˆ·ã€ç³»ç»Ÿæˆ–è€…è¿›ç¨‹å‘é€ç»™ç›®æ ‡è¿›ç¨‹çš„ä¿¡æ¯ï¼Œä»¥é€šçŸ¥ç›®æ ‡è¿›ç¨‹æŸä¸ªçŠ¶æ€çš„æ”¹å˜æˆ–ç³»ç»Ÿå¼‚å¸¸ã€‚</p><ul><li>å¯¹äºå‰å°è¿›ç¨‹ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è¾“å…¥ç‰¹æ®Šçš„ç»ˆç«¯å­—ç¬¦æ¥ç»™å®ƒå‘é€ä¿¡å·ã€‚æ¯”å¦‚è¾“å…¥Ctrl+Cé€šå¸¸ä¼šç»™è¿›ç¨‹å‘é€ä¸€ä¸ªä¸­æ–­ä¿¡å·ã€‚</li><li>ç³»ç»Ÿå¼‚å¸¸ã€‚æ¯”å¦‚æµ®ç‚¹å¼‚å¸¸å’Œéæ³•å†…å­˜æ®µè®¿é—®ã€‚</li><li>ç³»ç»ŸçŠ¶æ€å˜åŒ–ã€‚æ¯”å¦‚alarmå®šæ—¶å™¨åˆ°æœŸå°†å¼•èµ·SIGALRMä¿¡å·ã€‚</li><li>è¿è¡Œkillå‘½ä»¤æˆ–è°ƒç”¨killå‡½æ•°ã€‚</li></ul><p>æœåŠ¡å™¨ç¨‹åºå¿…é¡»å¤„ç†ï¼ˆæˆ–è‡³å°‘å¿½ç•¥ï¼‰ä¸€äº›å¸¸è§çš„ä¿¡å·ï¼Œä»¥å…å¼‚å¸¸ç»ˆæ­¢ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="linuxä¿¡å·æ¦‚è¿°"></a>Linuxä¿¡å·æ¦‚è¿°<a class="hash-link" href="#linuxä¿¡å·æ¦‚è¿°" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="å‘é€ä¿¡å·"></a>å‘é€ä¿¡å·<a class="hash-link" href="#å‘é€ä¿¡å·" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property"> </span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;sys/types.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property"> </span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;signal.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">kill</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">pid_t pid</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sig</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>è¯¥å‡½æ•°æŠŠä¿¡å·sigå‘é€ç»™ç›®æ ‡è¿›ç¨‹ï¼›ç›®æ ‡è¿›ç¨‹ç”±pidå‚æ•°æŒ‡å®š</p><p><img alt="image-20210910102750680" src="/assets/images/image-20210910102750680-4e2b561fa7793b2fbf91dec527404064.png"></p><p>Linuxå®šä¹‰çš„ä¿¡å·å€¼éƒ½å¤§äº0ï¼Œå¦‚æœsigå–å€¼ä¸º0ï¼Œåˆ™killå‡½æ•°ä¸å‘é€ä»»ä½•ä¿¡å·ã€‚</p><p>ä½†å°†sigè®¾ç½®ä¸º0å¯ä»¥ç”¨æ¥æ£€æµ‹ç›®æ ‡è¿›ç¨‹æˆ–è¿›ç¨‹ç»„æ˜¯å¦å­˜åœ¨ï¼Œå› ä¸ºæ£€æŸ¥å·¥ä½œæ€»æ˜¯åœ¨ä¿¡å·å‘é€ä¹‹å‰å°±æ‰§è¡Œã€‚ä¸è¿‡è¿™ç§æ£€æµ‹æ–¹å¼æ˜¯ä¸å¯é çš„ã€‚ä¸€æ–¹é¢ç”±äºè¿›ç¨‹PIDçš„å›ç»•ï¼Œå¯èƒ½å¯¼è‡´è¢«æ£€æµ‹çš„PIDä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„è¿›ç¨‹çš„PIDï¼›å¦ä¸€æ–¹é¢ï¼Œè¿™ç§æ£€æµ‹æ–¹æ³•ä¸æ˜¯åŸå­æ“ä½œã€‚</p><p>è¯¥å‡½æ•°æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®errnoã€‚</p><p><img alt="image-20210910102820462" src="/assets/images/image-20210910102820462-89efdc415fa02217e7e0b947e45e36f0.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ä¿¡å·å¤„ç†æ–¹å¼"></a>ä¿¡å·å¤„ç†æ–¹å¼<a class="hash-link" href="#ä¿¡å·å¤„ç†æ–¹å¼" title="Direct link to heading">#</a></h4><p>ç›®æ ‡è¿›ç¨‹åœ¨æ”¶åˆ°ä¿¡å·æ—¶ï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ªæ¥æ”¶å‡½æ•°æ¥å¤„ç†ä¹‹ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property"> </span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;signal.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">typedef</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">sighandler_t</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sighandler_t </span><span class="token function" style="color:rgb(130, 170, 255)">signal</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> signum</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> sighandler_t handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>ä¿¡å·å¤„ç†å‡½æ•°åªå¸¦æœ‰ä¸€ä¸ªæ•´å‹å‚æ•°ï¼Œè¯¥å‚æ•°ç”¨æ¥æŒ‡ç¤ºä¿¡å·ç±»å‹ã€‚ä¿¡å·å¤„ç†å‡½æ•°åº”è¯¥æ˜¯å¯é‡å…¥çš„ï¼Œå¦åˆ™å¾ˆå®¹æ˜“å¼•å‘ä¸€äº›ç«æ€æ¡ä»¶ã€‚æ‰€ä»¥åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­ä¸¥ç¦è°ƒç”¨ä¸€äº›ä¸å®‰å…¨çš„å‡½æ•°ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property"> </span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;bits/signum.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name function" style="color:rgb(130, 170, 255)">SIG_DFL</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression">__sighandler_t</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">0</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name function" style="color:rgb(130, 170, 255)">SIG_IGN</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression">__sighandler_t</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">1</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>SIG_IGNè¡¨ç¤ºå¿½ç•¥ç›®æ ‡ä¿¡å·ï¼ŒSIG_DFLè¡¨ç¤ºä½¿ç”¨ä¿¡å·çš„é»˜è®¤å¤„ç†æ–¹å¼ã€‚ä¿¡å·çš„é»˜è®¤å¤„ç†æ–¹å¼æœ‰å¦‚ä¸‹å‡ ç§ï¼šç»“æŸè¿›ç¨‹ï¼ˆTermï¼‰ã€å¿½ç•¥ä¿¡å·ï¼ˆIgnï¼‰ã€ç»“æŸè¿›ç¨‹å¹¶ç”Ÿæˆæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ï¼ˆCoreï¼‰ã€æš‚åœè¿›ç¨‹ï¼ˆStopï¼‰ï¼Œä»¥åŠç»§ç»­è¿›ç¨‹ï¼ˆContï¼‰ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="linuxä¿¡å·"></a>Linuxä¿¡å·<a class="hash-link" href="#linuxä¿¡å·" title="Direct link to heading">#</a></h4><p>Linuxçš„å¯ç”¨ä¿¡å·éƒ½å®šä¹‰åœ¨bits/signum.hå¤´æ–‡ä»¶ä¸­ï¼Œå…¶ä¸­åŒ…æ‹¬æ ‡å‡†ä¿¡å·å’ŒPOSIXå®æ—¶ä¿¡å·ã€‚</p><p><img alt="image-20210910103040544" src="/assets/images/image-20210910103040544-b02b6f9f3e440f5aa9106b100b89ed91.png"></p><p><img alt="image-20210910103044184" src="/assets/images/image-20210910103044184-81a972fcac09180533a361fdc88071fe.png"></p><p>ç½‘ç»œç¼–ç¨‹å…³ç³»ç´§å¯†çš„å‡ ä¸ªä¿¡å·ï¼šSIGHUPã€SIGPIPEå’ŒSIGURGã€‚ä»‹ç»SIGALRMã€SIGCHLDç­‰ä¿¡å·çš„ä½¿ç”¨ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ä¸­æ–­ç³»ç»Ÿè°ƒç”¨"></a>ä¸­æ–­ç³»ç»Ÿè°ƒç”¨<a class="hash-link" href="#ä¸­æ–­ç³»ç»Ÿè°ƒç”¨" title="Direct link to heading">#</a></h4><p>å¦‚æœç¨‹åºåœ¨æ‰§è¡Œå¤„äºé˜»å¡çŠ¶æ€çš„ç³»ç»Ÿè°ƒç”¨æ—¶æ¥æ”¶åˆ°ä¿¡å·ï¼Œå¹¶ä¸”æˆ‘ä»¬ä¸ºè¯¥ä¿¡å·è®¾ç½®äº†ä¿¡å·å¤„ç†å‡½æ•°ï¼Œåˆ™é»˜è®¤æƒ…å†µä¸‹ç³»ç»Ÿè°ƒç”¨å°†è¢«ä¸­æ–­ï¼Œå¹¶ä¸”errnoè¢«è®¾ç½®ä¸ºEINTRã€‚</p><p>å¯ä»¥ä½¿ç”¨sigactionå‡½æ•°ï¼ˆè§åæ–‡ï¼‰ä¸ºä¿¡å·è®¾ç½®SA_RESTARTæ ‡å¿—ä»¥è‡ªåŠ¨é‡å¯è¢«è¯¥ä¿¡å·ä¸­æ–­çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p><p>å¯¹äºé»˜è®¤è¡Œä¸ºæ˜¯æš‚åœè¿›ç¨‹çš„ä¿¡å·ï¼ˆæ¯”å¦‚SIGSTOPã€SIGTTINï¼‰ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰ä¸ºå®ƒä»¬è®¾ç½®ä¿¡å·å¤„ç†å‡½æ•°ï¼Œåˆ™å®ƒä»¬ä¹Ÿå¯ä»¥ä¸­æ–­æŸäº›ç³»ç»Ÿè°ƒç”¨ï¼ˆæ¯”å¦‚connectã€epoll_waitï¼‰ã€‚POSIXæ²¡æœ‰è§„å®šè¿™ç§è¡Œä¸ºï¼Œè¿™æ˜¯Linuxç‹¬æœ‰çš„ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ä¿¡å·å‡½æ•°"></a>ä¿¡å·å‡½æ•°<a class="hash-link" href="#ä¿¡å·å‡½æ•°" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="signalç³»ç»Ÿè°ƒç”¨"></a>signalç³»ç»Ÿè°ƒç”¨<a class="hash-link" href="#signalç³»ç»Ÿè°ƒç”¨" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property"> </span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;signal.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sighandler_t </span><span class="token function" style="color:rgb(130, 170, 255)">signal</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> signum</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> sighandler_t handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>sigå‚æ•°æŒ‡å‡ºè¦æ•è·çš„ä¿¡å·ç±»å‹ã€‚<code>_handler</code>å‚æ•°æ˜¯<code>_sighandler_t</code>ç±»å‹çš„å‡½æ•°æŒ‡é’ˆï¼Œç”¨äºæŒ‡å®šä¿¡å·sigçš„å¤„ç†å‡½æ•°ã€‚</p><p>signalå‡½æ•°æˆåŠŸæ—¶è¿”å›ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œè¯¥å‡½æ•°æŒ‡é’ˆçš„ç±»å‹ä¹Ÿæ˜¯_sighandler_tã€‚è¿™ä¸ªè¿”å›å€¼æ˜¯å‰ä¸€æ¬¡è°ƒç”¨signalå‡½æ•°æ—¶ä¼ å…¥çš„å‡½æ•°æŒ‡é’ˆï¼Œæˆ–è€…æ˜¯ä¿¡å·sigå¯¹åº”çš„é»˜è®¤å¤„ç†å‡½æ•°æŒ‡é’ˆSIG_DEFï¼ˆå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨signalçš„è¯ï¼‰ã€‚</p><p>signalç³»ç»Ÿè°ƒç”¨å‡ºé”™æ—¶è¿”å›SIG_ERRï¼Œå¹¶è®¾ç½®errnoã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="sigactionç³»ç»Ÿè°ƒç”¨"></a>sigactionç³»ç»Ÿè°ƒç”¨<a class="hash-link" href="#sigactionç³»ç»Ÿè°ƒç”¨" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property"> </span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;signal.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">sigaction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sig</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sigaction</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">act</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sigaction</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">oact</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>sigå‚æ•°æŒ‡å‡ºè¦æ•è·çš„ä¿¡å·ç±»å‹ï¼Œactå‚æ•°æŒ‡å®šæ–°çš„ä¿¡å·å¤„ç†æ–¹å¼ï¼Œoactå‚æ•°åˆ™è¾“å‡ºä¿¡å·å…ˆå‰çš„å¤„ç†æ–¹å¼ï¼ˆå¦‚æœä¸ä¸ºNULLçš„è¯ï¼‰ã€‚actå’Œoactéƒ½æ˜¯sigactionç»“æ„ä½“ç±»å‹çš„æŒ‡é’ˆ</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sigaction</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/* Signal handler.  */</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">if</span><span class="token macro property"> </span><span class="token macro property expression">defined __USE_POSIX199309 </span><span class="token macro property expression operator" style="color:rgb(137, 221, 255)">||</span><span class="token macro property expression"> defined __USE_XOPEN_EXTENDED</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">union</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/* Used if SA_SIGINFO is not set.  */</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    __sighandler_t sa_handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/* Used if SA_SIGINFO is set.  */</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">sa_sigaction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> siginfo_t </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    __sigaction_handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property"> </span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">sa_handler</span><span class="token macro property"> </span><span class="token macro property expression">__sigaction_handler</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token macro property expression">sa_handler</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property"> </span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">sa_sigaction</span><span class="token macro property">   </span><span class="token macro property expression">__sigaction_handler</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token macro property expression">sa_sigaction</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">else</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    __sighandler_t sa_handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">endif</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/* Additional set of signals to be blocked.  */</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    __sigset_t sa_mask</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/* Special flags.  */</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sa_flags</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/* Restore handler.  */</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">sa_restorer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">void</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>è¯¥ç»“æ„ä½“ä¸­çš„sa_handeræˆå‘˜æŒ‡å®šä¿¡å·å¤„ç†å‡½æ•°ã€‚sa_maskæˆå‘˜è®¾ç½®è¿›ç¨‹çš„ä¿¡å·æ©ç ï¼ˆç¡®åˆ‡åœ°è¯´æ˜¯åœ¨è¿›ç¨‹åŸæœ‰ä¿¡å·æ©ç çš„åŸºç¡€ä¸Šå¢åŠ ä¿¡å·æ©ç ï¼‰ï¼Œä»¥æŒ‡å®šå“ªäº›ä¿¡å·ä¸èƒ½å‘é€ç»™æœ¬è¿›ç¨‹ã€‚sa_maskæ˜¯ä¿¡å·é›†sigset_tï¼ˆ_sigset_tçš„åŒä¹‰è¯ï¼‰ç±»å‹ï¼Œè¯¥ç±»å‹æŒ‡å®šä¸€ç»„ä¿¡å·</p><p><img alt="image-20210910103826018" src="/assets/images/image-20210910103826018-de30d689f1053f510792423523fa6ff7.png"></p><p>sa_restoreræˆå‘˜å·²ç»è¿‡æ—¶ï¼Œæœ€å¥½ä¸è¦ä½¿ç”¨ã€‚sigactionæˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®errnoã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ä¿¡å·é›†"></a>ä¿¡å·é›†<a class="hash-link" href="#ä¿¡å·é›†" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ä¿¡å·é›†å‡½æ•°"></a>ä¿¡å·é›†å‡½æ•°<a class="hash-link" href="#ä¿¡å·é›†å‡½æ•°" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property expression function" style="color:rgb(130, 170, 255)">_SIGSET_NWORDS</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">1024</span><span class="token macro property expression operator" style="color:rgb(137, 221, 255)">/</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">8</span><span class="token macro property expression operator" style="color:rgb(137, 221, 255)">*</span><span class="token macro property expression keyword" style="font-style:italic">sizeof</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression keyword" style="font-style:italic">unsigned</span><span class="token macro property expression"> </span><span class="token macro property expression keyword" style="font-style:italic">long</span><span class="token macro property expression"> </span><span class="token macro property expression keyword" style="font-style:italic">int</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">typedef</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">unsigned</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">long</span><span class="token plain"> int__val</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">_SIGSET_NWORDS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">__sigset_t</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>sigset_tå®é™…ä¸Šæ˜¯ä¸€ä¸ªé•¿æ•´å‹æ•°ç»„ï¼Œæ•°ç»„çš„æ¯ä¸ªå…ƒç´ çš„æ¯ä¸ªä½è¡¨ç¤ºä¸€ä¸ªä¿¡å·ã€‚è¿™ç§å®šä¹‰æ–¹å¼å’Œæ–‡ä»¶æè¿°ç¬¦é›†fd_setç±»ä¼¼ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property"> </span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;signal.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">sigemptyset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sigset_t </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*æ¸…ç©ºä¿¡å·é›†*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">sigfillset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sigset_t </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">åœ¨ä¿¡å·é›†ä¸­è®¾ç½®æ‰€æœ‰ä¿¡å·</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">sigaddset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sigset_t </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> signum</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å°†ä¿¡å·_signoæ·»åŠ è‡³ä¿¡å·é›†ä¸­*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">sigdelset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sigset_t </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> signum</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å°†ä¿¡å·_signoä»ä¿¡å·é›†ä¸­åˆ é™¤*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">sigismember</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> sigset_t </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> signum</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*æµ‹è¯•_signoæ˜¯å¦åœ¨ä¿¡å·é›†ä¸­*/</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="è¿›ç¨‹ä¿¡å·æ©ç "></a>è¿›ç¨‹ä¿¡å·æ©ç <a class="hash-link" href="#è¿›ç¨‹ä¿¡å·æ©ç " title="Direct link to heading">#</a></h4><p>å¯ä»¥åˆ©ç”¨sigactionç»“æ„ä½“çš„sa_maskæˆå‘˜æ¥è®¾ç½®è¿›ç¨‹çš„ä¿¡å·æ©ç ã€‚æ­¤å¤–ï¼Œå¦‚ä¸‹å‡½æ•°ä¹Ÿå¯ä»¥ç”¨äºè®¾ç½®æˆ–æŸ¥çœ‹è¿›ç¨‹çš„ä¿¡å·æ©ç ï¼š</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property"> </span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;signal.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">sigprocmask</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> how</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> sigset_t </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> sigset_t </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">oldset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>setå‚æ•°æŒ‡å®šæ–°çš„ä¿¡å·æ©ç ï¼Œosetå‚æ•°åˆ™è¾“å‡ºåŸæ¥çš„ä¿¡å·æ©ç ï¼ˆå¦‚æœä¸ä¸ºNULLçš„è¯ï¼‰ã€‚å¦‚æœsetå‚æ•°ä¸ä¸ºNULLï¼Œåˆ™howå‚æ•°æŒ‡å®šè®¾ç½®è¿›ç¨‹ä¿¡å·æ©ç çš„æ–¹å¼ï¼Œ</p><p><img alt="image-20210910104826934" src="/assets/images/image-20210910104826934-15f1590d62ca3a2267c26424870ac94d.png"></p><p>å¦‚æœsetä¸ºNULLï¼Œåˆ™è¿›ç¨‹ä¿¡å·æ©ç ä¸å˜ï¼Œæ­¤æ—¶æˆ‘ä»¬ä»ç„¶å¯ä»¥åˆ©ç”¨osetå‚æ•°æ¥è·å¾—è¿›ç¨‹å½“å‰çš„ä¿¡å·æ©ç ã€‚</p><p>sigprocmaskæˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®errnoã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="è¢«æŒ‚èµ·çš„ä¿¡å·"></a>è¢«æŒ‚èµ·çš„ä¿¡å·<a class="hash-link" href="#è¢«æŒ‚èµ·çš„ä¿¡å·" title="Direct link to heading">#</a></h4><p>è®¾ç½®è¿›ç¨‹ä¿¡å·æ©ç åï¼Œè¢«å±è”½çš„ä¿¡å·å°†ä¸èƒ½è¢«è¿›ç¨‹æ¥æ”¶ã€‚å¦‚æœç»™è¿›ç¨‹å‘é€ä¸€ä¸ªè¢«å±è”½çš„ä¿¡å·ï¼Œåˆ™æ“ä½œç³»ç»Ÿå°†è¯¥ä¿¡å·è®¾ç½®ä¸ºè¿›ç¨‹çš„ä¸€ä¸ªè¢«æŒ‚èµ·çš„ä¿¡å·ã€‚å¦‚æœæˆ‘ä»¬å–æ¶ˆå¯¹è¢«æŒ‚èµ·ä¿¡å·çš„å±è”½ï¼Œåˆ™å®ƒèƒ½ç«‹å³è¢«è¿›ç¨‹æ¥æ”¶åˆ°ã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property"> </span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;signal.h&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">sigpending</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sigset_t</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>setå‚æ•°ç”¨äºä¿å­˜è¢«æŒ‚èµ·çš„ä¿¡å·é›†ã€‚æ˜¾ç„¶ï¼Œè¿›ç¨‹å³ä½¿å¤šæ¬¡æ¥æ”¶åˆ°åŒä¸€ä¸ªè¢«æŒ‚èµ·çš„ä¿¡å·ï¼Œsigpendingå‡½æ•°ä¹Ÿåªèƒ½åæ˜ ä¸€æ¬¡ã€‚å¹¶ä¸”ï¼Œå½“æˆ‘ä»¬å†æ¬¡ä½¿ç”¨sigprocmaskä½¿èƒ½è¯¥æŒ‚èµ·çš„ä¿¡å·æ—¶ï¼Œè¯¥ä¿¡å·çš„å¤„ç†å‡½æ•°ä¹Ÿåªè¢«è§¦å‘ä¸€æ¬¡ã€‚</p><p>sigpendingæˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®errnoã€‚</p><p>å§‹ç»ˆæ¸…æ¥šåœ°çŸ¥é“è¿›ç¨‹åœ¨æ¯ä¸ªè¿è¡Œæ—¶åˆ»çš„ä¿¡å·æ©ç ï¼Œä»¥åŠå¦‚ä½•é€‚å½“åœ°å¤„ç†æ•è·åˆ°çš„ä¿¡å·ã€‚åœ¨å¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬è¦ä»¥è¿›ç¨‹ã€çº¿ç¨‹ä¸ºå•ä½æ¥å¤„ç†ä¿¡å·å’Œä¿¡å·æ©ç ã€‚æˆ‘ä»¬ä¸èƒ½è®¾æƒ³æ–°åˆ›å»ºçš„è¿›ç¨‹ã€çº¿ç¨‹å…·æœ‰å’Œçˆ¶è¿›ç¨‹ã€ä¸»çº¿ç¨‹å®Œå…¨ç›¸åŒçš„ä¿¡å·ç‰¹å¾ã€‚æ¯”å¦‚ï¼Œforkè°ƒç”¨äº§ç”Ÿçš„å­è¿›ç¨‹å°†ç»§æ‰¿çˆ¶è¿›ç¨‹çš„ä¿¡å·æ©ç ï¼Œä½†å…·æœ‰ä¸€ä¸ªç©ºçš„æŒ‚èµ·ä¿¡å·é›†ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ç»Ÿä¸€äº‹ä»¶æº"></a>ç»Ÿä¸€äº‹ä»¶æº<a class="hash-link" href="#ç»Ÿä¸€äº‹ä»¶æº" title="Direct link to heading">#</a></h3><p>ä¿¡å·æ˜¯ä¸€ç§å¼‚æ­¥äº‹ä»¶ï¼šä¿¡å·å¤„ç†å‡½æ•°å’Œç¨‹åºçš„ä¸»å¾ªç¯æ˜¯ä¸¤æ¡ä¸åŒçš„æ‰§è¡Œè·¯çº¿ã€‚å¾ˆæ˜¾ç„¶ï¼Œä¿¡å·å¤„ç†å‡½æ•°éœ€è¦å°½å¯èƒ½å¿«åœ°æ‰§è¡Œå®Œæ¯•ï¼Œä»¥ç¡®ä¿è¯¥ä¿¡å·ä¸è¢«å±è”½ï¼ˆå‰é¢æåˆ°è¿‡ï¼Œä¸ºäº†é¿å…ä¸€äº›ç«æ€æ¡ä»¶ï¼Œä¿¡å·åœ¨å¤„ç†æœŸé—´ï¼Œç³»ç»Ÿä¸ä¼šå†æ¬¡è§¦å‘å®ƒï¼‰å¤ªä¹…ã€‚</p><p>ä¸€ç§å…¸å‹çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šæŠŠä¿¡å·çš„ä¸»è¦å¤„ç†é€»è¾‘æ”¾åˆ°ç¨‹åºçš„ä¸»å¾ªç¯ä¸­ï¼Œå½“ä¿¡å·å¤„ç†å‡½æ•°è¢«è§¦å‘æ—¶ï¼Œå®ƒåªæ˜¯ç®€å•åœ°é€šçŸ¥ä¸»å¾ªç¯ç¨‹åºæ¥æ”¶åˆ°ä¿¡å·ï¼Œå¹¶æŠŠä¿¡å·å€¼ä¼ é€’ç»™ä¸»å¾ªç¯ï¼Œä¸»å¾ªç¯å†æ ¹æ®æ¥æ”¶åˆ°çš„ä¿¡å·å€¼æ‰§è¡Œç›®æ ‡ä¿¡å·å¯¹åº”çš„é€»è¾‘ä»£ç ã€‚</p><p>ä¿¡å·å¤„ç†å‡½æ•°é€šå¸¸ä½¿ç”¨ç®¡é“æ¥å°†ä¿¡å·â€œä¼ é€’â€ç»™ä¸»å¾ªç¯ï¼šä¿¡å·å¤„ç†å‡½æ•°å¾€ç®¡é“çš„å†™ç«¯å†™å…¥ä¿¡å·å€¼ï¼Œä¸»å¾ªç¯åˆ™ä»ç®¡é“çš„è¯»ç«¯è¯»å‡ºè¯¥ä¿¡å·å€¼ã€‚</p><p>é‚£ä¹ˆä¸»å¾ªç¯æ€ä¹ˆçŸ¥é“ç®¡é“ä¸Šä½•æ—¶æœ‰æ•°æ®å¯è¯»å‘¢?è¿™å¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨I/Oå¤ç”¨ç³»ç»Ÿè°ƒç”¨æ¥ç›‘å¬ç®¡é“çš„è¯»ç«¯æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„å¯è¯»äº‹ä»¶ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œä¿¡å·äº‹ä»¶å°±èƒ½å’Œå…¶ä»–I/Oäº‹ä»¶ä¸€æ ·è¢«å¤„ç†ï¼Œå³ç»Ÿä¸€äº‹ä»¶æºã€‚</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><div tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">MAX_EVENT_NUMBER</span><span class="token macro property"> </span><span class="token macro property expression number" style="color:rgb(247, 140, 108)">1024</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">static</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> pipefd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">setnonblocking</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> old_option</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">fcntl</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">F_GETFL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> new_option</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">old_option</span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">O_NONBLOCK</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">fcntl</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">F_SETFL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">new_option</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> old_option</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">addfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    epoll_event event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">fd</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">events</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">EPOLLIN</span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain">EPOLLET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">epoll_ctl</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">EPOLL_CTL_ADD</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ï¼†event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">setnonblocking</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*ä¿¡å·å¤„ç†å‡½æ•°*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">sig_handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sig</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*ä¿ç•™åŸæ¥çš„errnoï¼Œåœ¨å‡½æ•°æœ€åæ¢å¤ï¼Œä»¥ä¿è¯å‡½æ•°çš„å¯é‡å…¥æ€§*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> save_errno</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">errno</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> msg</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">sig</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">send</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">pipefd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">ï¼†msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å°†ä¿¡å·å€¼å†™å…¥ç®¡é“ï¼Œä»¥é€šçŸ¥ä¸»å¾ªç¯*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    errno</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">save_errno</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*è®¾ç½®ä¿¡å·çš„å¤„ç†å‡½æ•°*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">addsig</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sig</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sigaction</span><span class="token plain"> sa</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">memset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ï¼†sa</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;\0&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sa</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    sa</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sa_handler</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">sig_handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    sa</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sa_flags</span><span class="token operator" style="color:rgb(137, 221, 255)">|=</span><span class="token plain">SA_RESTART</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">sigfillset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ï¼†sa</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sa_mask</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">assert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">sigaction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sig</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ï¼†sa</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token constant" style="color:rgb(130, 170, 255)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">!=</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">main</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">argcï¼œ</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;usage:%s ip_address port_number\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token function" style="color:rgb(130, 170, 255)">basename</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">ip</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">argv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> port</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">atoi</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> ret</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr_in</span><span class="token plain"> address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">bzero</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ï¼†address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_family</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">AF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">inet_pton</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">AF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ip</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ï¼†address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_addr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">sin_port</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">htons</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> listenfd</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">socket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">PF_INET</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">SOCK_STREAM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">assert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">listenfdï¼</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ret</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">bind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">ï¼†address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ret</span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;errno is%d\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">errno</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ret</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">listen</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">5</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">assert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ret</span><span class="token operator" style="color:rgb(137, 221, 255)">!=</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    epoll_event events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">MAX_EVENT_NUMBER</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> epollfd</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">epoll_create</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">5</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">assert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">epollfd</span><span class="token operator" style="color:rgb(137, 221, 255)">!=</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">addfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*ä½¿ç”¨socketpairåˆ›å»ºç®¡é“ï¼Œæ³¨å†Œpipefd[0]ä¸Šçš„å¯è¯»äº‹ä»¶*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ret</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">socketpair</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">PF_UNIX</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">SOCK_STREAM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">pipefd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">assert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ret</span><span class="token operator" style="color:rgb(137, 221, 255)">!=</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">setnonblocking</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">pipefd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">addfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">pipefd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*è®¾ç½®ä¸€äº›ä¿¡å·çš„å¤„ç†å‡½æ•°*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">addsig</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">SIGHUP</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">addsig</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">SIGCHLD</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">addsig</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">SIGTERM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">addsig</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">SIGINT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">bool</span><span class="token plain"> stop_server</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token boolean" style="color:rgb(255, 88, 116)">false</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">while</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain">stop_server</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> number</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">epoll_wait</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">MAX_EVENT_NUMBER</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">numberï¼œ</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">ï¼†ï¼†</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">errno</span><span class="token operator" style="color:rgb(137, 221, 255)">!=</span><span class="token plain">EINTR</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;epoll failure\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">break</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">for</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> i</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">iï¼œnumber</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">i</span><span class="token operator" style="color:rgb(137, 221, 255)">++</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sockfd</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">fd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å¦‚æœå°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦æ˜¯listenfdï¼Œåˆ™å¤„ç†æ–°çš„è¿æ¥*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sockfd</span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain">listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr_in</span><span class="token plain"> client_address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                socklen_t client_addrlength</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">client_address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> connfd</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">accept</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">sockaddr</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                  ï¼†client_address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">ï¼†client_addrlength</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token function" style="color:rgb(130, 170, 255)">addfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">epollfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">connfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å¦‚æœå°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦æ˜¯pipefd[0]ï¼Œåˆ™å¤„ç†ä¿¡å·*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sockfd</span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain">pipefd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">ï¼†ï¼†</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">events</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">eventsï¼†EPOLLIN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> sig</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> signals</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1024</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                ret</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token function" style="color:rgb(130, 170, 255)">recv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">pipefd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">signals</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token keyword" style="font-style:italic">sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">signals</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ret</span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token keyword" style="font-style:italic">continue</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ret</span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token keyword" style="font-style:italic">continue</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*å› ä¸ºæ¯ä¸ªä¿¡å·å€¼å 1å­—èŠ‚ï¼Œæ‰€ä»¥æŒ‰å­—èŠ‚æ¥é€ä¸ªæ¥æ”¶ä¿¡å·ã€‚æˆ‘ä»¬ä»¥SIGTERMä¸ºä¾‹ï¼Œæ¥è¯´æ˜å¦‚ä½•å®‰å…¨åœ°ç»ˆæ­¢æœåŠ¡å™¨ä¸»å¾ªç¯*/</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token keyword" style="font-style:italic">for</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> i</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">iï¼œret</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token operator" style="color:rgb(137, 221, 255)">++</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        </span><span class="token keyword" style="font-style:italic">switch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">signals</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> SIGCHLD</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> SIGHUP</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                </span><span class="token keyword" style="font-style:italic">continue</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> SIGTERM</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> SIGINT</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                stop_server</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;close fds\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">close</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">listenfd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">close</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">pipefd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">close</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">pipefd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ç½‘ç»œç¼–ç¨‹ç›¸å…³ä¿¡å·"></a>ç½‘ç»œç¼–ç¨‹ç›¸å…³ä¿¡å·<a class="hash-link" href="#ç½‘ç»œç¼–ç¨‹ç›¸å…³ä¿¡å·" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="sighup"></a>SIGHUP<a class="hash-link" href="#sighup" title="Direct link to heading">#</a></h4><p>å½“æŒ‚èµ·è¿›ç¨‹çš„æ§åˆ¶ç»ˆç«¯æ—¶ï¼ŒSIGHUPä¿¡å·å°†è¢«è§¦å‘ã€‚å¯¹äºæ²¡æœ‰æ§åˆ¶ç»ˆç«¯çš„ç½‘ç»œåå°ç¨‹åºè€Œè¨€ï¼Œå®ƒä»¬é€šå¸¸åˆ©ç”¨SIGHUPä¿¡å·æ¥å¼ºåˆ¶æœåŠ¡å™¨é‡è¯»é…ç½®æ–‡ä»¶ã€‚ä¸€ä¸ªå…¸å‹çš„ä¾‹å­æ˜¯xinetdè¶…çº§æœåŠ¡ç¨‹åºã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="sigpipe"></a>SIGPIPE<a class="hash-link" href="#sigpipe" title="Direct link to heading">#</a></h4><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¾€ä¸€ä¸ªè¯»ç«¯å…³é—­çš„ç®¡é“æˆ–socketè¿æ¥ä¸­å†™æ•°æ®å°†å¼•å‘SIGPIPEä¿¡å·ã€‚æˆ‘ä»¬éœ€è¦åœ¨ä»£ç ä¸­æ•è·å¹¶å¤„ç†è¯¥ä¿¡å·ï¼Œæˆ–è€…è‡³å°‘å¿½ç•¥å®ƒï¼Œå› ä¸ºç¨‹åºæ¥æ”¶åˆ°SIGPIPEä¿¡å·çš„é»˜è®¤è¡Œä¸ºæ˜¯ç»“æŸè¿›ç¨‹ï¼Œè€Œæˆ‘ä»¬ç»å¯¹ä¸å¸Œæœ›å› ä¸ºé”™è¯¯çš„å†™æ“ä½œè€Œå¯¼è‡´ç¨‹åºé€€å‡ºã€‚å¼•èµ·SIGPIPEä¿¡å·çš„å†™æ“ä½œå°†è®¾ç½®errnoä¸ºEPIPEã€‚</p><p>ç¬¬5ç« æåˆ°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨sendå‡½æ•°çš„MSG_NOSIGNALæ ‡å¿—æ¥ç¦æ­¢å†™æ“ä½œè§¦å‘SIGPIPEä¿¡å·ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨sendå‡½æ•°åé¦ˆçš„errnoå€¼æ¥åˆ¤æ–­ç®¡é“æˆ–è€…socketè¿æ¥çš„è¯»ç«¯æ˜¯å¦å·²ç»å…³é—­ã€‚</p><p>æ­¤å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨I/Oå¤ç”¨ç³»ç»Ÿè°ƒç”¨æ¥æ£€æµ‹ç®¡é“å’Œsocketè¿æ¥çš„è¯»ç«¯æ˜¯å¦å·²ç»å…³é—­ã€‚ä»¥pollä¸ºä¾‹ï¼Œå½“ç®¡é“çš„è¯»ç«¯å…³é—­æ—¶ï¼Œå†™ç«¯æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„POLLHUPäº‹ä»¶å°†è¢«è§¦å‘ï¼›å½“socketè¿æ¥è¢«å¯¹æ–¹å…³é—­æ—¶ï¼Œsocketä¸Šçš„POLLRDHUPäº‹ä»¶å°†è¢«è§¦å‘ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="sigurg"></a>SIGURG<a class="hash-link" href="#sigurg" title="Direct link to heading">#</a></h4><p>åœ¨Linuxç¯å¢ƒä¸‹ï¼Œå†…æ ¸é€šçŸ¥åº”ç”¨ç¨‹åºå¸¦å¤–æ•°æ®åˆ°è¾¾ä¸»è¦æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><p>ä¸€ç§æ˜¯ç¬¬9ç« ä»‹ç»çš„I/Oå¤ç”¨æŠ€æœ¯ï¼Œselectç­‰ç³»ç»Ÿè°ƒç”¨åœ¨æ¥æ”¶åˆ°å¸¦å¤–æ•°æ®æ—¶å°†è¿”å›ï¼Œå¹¶å‘åº”ç”¨ç¨‹åºæŠ¥å‘Šsocketä¸Šçš„å¼‚å¸¸äº‹ä»¶ï¼Œä»£ç æ¸…å•9-1ç»™å‡ºäº†ä¸€ä¸ªè¿™æ–¹é¢çš„ä¾‹å­ï¼›</p><p>å¦å¤–ä¸€ç§æ–¹æ³•å°±æ˜¯ä½¿ç”¨SIGURGä¿¡å·ï¼Œå¦‚ä»£ç æ¸…å•10-3æ‰€ç¤ºã€‚</p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬è®¨è®ºå®Œäº†TCPå¸¦å¤–æ•°æ®ç›¸å…³çš„æ‰€æœ‰çŸ¥è¯†ã€‚ä¸‹é¢å¸®åŠ©è¯»è€…é‡æ–°æ¢³ç†ä¸€ä¸‹ã€‚3.8èŠ‚ä¸­æˆ‘ä»¬ä»‹ç»äº†TCPå¸¦å¤–æ•°æ®çš„åŸºæœ¬çŸ¥è¯†ï¼Œå…¶ä¸­æ¢è®¨äº†TCPæ¨¡å—æ˜¯å¦‚ä½•å‘é€å’Œæ¥æ”¶å¸¦å¤–æ•°æ®çš„ã€‚5.8.1å°èŠ‚æè¿°äº†å¦‚ä½•åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å¸¦MSG_OOBæ ‡å¿—çš„send/recvç³»ç»Ÿè°ƒç”¨æ¥å‘é€/æ¥æ”¶å¸¦å¤–æ•°æ®ï¼Œå¹¶ç»™å‡ºäº†ç›¸å…³ä»£ç ã€‚9.1.3å°èŠ‚å’Œ10.5.3å°èŠ‚åˆ†åˆ«ä»‹ç»äº†æ£€æµ‹å¸¦å¤–æ•°æ®æ˜¯å¦åˆ°è¾¾çš„ä¸¤ç§æ–¹æ³•ï¼šI/Oå¤ç”¨ç³»ç»Ÿè°ƒç”¨æŠ¥å‘Šçš„å¼‚å¸¸äº‹ä»¶å’ŒSIGURGä¿¡å·ã€‚ä½†åº”ç”¨ç¨‹åºæ£€æµ‹åˆ°å¸¦å¤–æ•°æ®åˆ°è¾¾åï¼Œæˆ‘ä»¬è¿˜éœ€è¦è¿›ä¸€æ­¥åˆ¤æ–­å¸¦å¤–æ•°æ®åœ¨æ•°æ®æµä¸­çš„å…·ä½“ä½ç½®ï¼Œæ‰èƒ½å¤Ÿå‡†ç¡®æ— è¯¯åœ°è¯»å–å¸¦å¤–æ•°æ®ã€‚5.9èŠ‚ä»‹ç»çš„sockatmarkç³»ç»Ÿè°ƒç”¨å°±æ˜¯ä¸“é—¨ç”¨äºè§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚å®ƒåˆ¤æ–­ä¸€ä¸ªsocketæ˜¯å¦å¤„äºå¸¦å¤–æ ‡è®°ï¼Œå³è¯¥socketä¸Šä¸‹ä¸€ä¸ªå°†è¢«è¯»å–åˆ°çš„æ•°æ®æ˜¯å¦æ˜¯å¸¦å¤–æ•°æ®ã€‚</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ç¬¬11ç« -å®šæ—¶å™¨"></a>ç¬¬11ç«  å®šæ—¶å™¨<a class="hash-link" href="#ç¬¬11ç« -å®šæ—¶å™¨" title="Direct link to heading">#</a></h2><p>ç½‘ç»œç¨‹åºéœ€è¦å¤„ç†çš„ç¬¬ä¸‰ç±»äº‹ä»¶æ˜¯å®šæ—¶äº‹ä»¶ï¼Œæ¯”å¦‚å®šæœŸæ£€æµ‹ä¸€ä¸ªå®¢æˆ·è¿æ¥çš„æ´»åŠ¨çŠ¶æ€ã€‚æœåŠ¡å™¨ç¨‹åºé€šå¸¸ç®¡ç†ç€ä¼—å¤šå®šæ—¶äº‹ä»¶ï¼Œå› æ­¤æœ‰æ•ˆåœ°ç»„ç»‡è¿™äº›å®šæ—¶äº‹ä»¶ï¼Œä½¿ä¹‹èƒ½åœ¨é¢„æœŸçš„æ—¶é—´ç‚¹è¢«è§¦å‘ä¸”ä¸å½±å“æœåŠ¡å™¨çš„ä¸»è¦é€»è¾‘ï¼Œå¯¹äºæœåŠ¡å™¨çš„æ€§èƒ½æœ‰ç€è‡³å…³é‡è¦çš„å½±å“ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬è¦å°†æ¯ä¸ªå®šæ—¶äº‹ä»¶åˆ†åˆ«å°è£…æˆå®šæ—¶å™¨ï¼Œå¹¶ä½¿ç”¨æŸç§å®¹å™¨ç±»æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚é“¾è¡¨ã€æ’åºé“¾è¡¨å’Œæ—¶é—´è½®ï¼Œå°†æ‰€æœ‰å®šæ—¶å™¨ä¸²è”èµ·æ¥ï¼Œä»¥å®ç°å¯¹å®šæ—¶äº‹ä»¶çš„ç»Ÿä¸€ç®¡ç†ã€‚</p><p>æœ¬ç« ä¸»è¦è®¨è®ºçš„å°±æ˜¯ä¸¤ç§é«˜æ•ˆçš„ç®¡ç†å®šæ—¶å™¨çš„å®¹å™¨ï¼šæ—¶é—´è½®å’Œæ—¶é—´å †ã€‚</p><p>å®šæ—¶æ˜¯æŒ‡åœ¨ä¸€æ®µæ—¶é—´ä¹‹åè§¦å‘æŸæ®µä»£ç çš„æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™æ®µä»£ç ä¸­ä¾æ¬¡å¤„ç†æ‰€æœ‰åˆ°æœŸçš„å®šæ—¶å™¨ã€‚æ¢è¨€ä¹‹ï¼Œå®šæ—¶æœºåˆ¶æ˜¯å®šæ—¶å™¨å¾—ä»¥è¢«å¤„ç†çš„åŸåŠ¨åŠ›ã€‚</p><p>Linuxæä¾›äº†ä¸‰ç§å®šæ—¶æ–¹æ³•</p><ul><li>socketé€‰é¡¹SO_RCVTIMEOå’ŒSO_SNDTIMEOã€‚</li><li>SIGALRMä¿¡å·ã€‚</li><li>I/Oå¤ç”¨ç³»ç»Ÿè°ƒç”¨çš„è¶…æ—¶å‚æ•°ã€‚</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="socketé€‰é¡¹so_rcvtimeoå’Œso_sndtimeo"></a>socketé€‰é¡¹SO_RCVTIMEOå’ŒSO_SNDTIMEO<a class="hash-link" href="#socketé€‰é¡¹so_rcvtimeoå’Œso_sndtimeo" title="Direct link to heading">#</a></h3><p>socketé€‰é¡¹SO_RCVTIMEOå’ŒSO_SNDTIMEOï¼Œå®ƒä»¬åˆ†åˆ«ç”¨æ¥è®¾ç½®socketæ¥æ”¶æ•°æ®è¶…æ—¶æ—¶é—´å’Œå‘é€æ•°æ®è¶…æ—¶æ—¶é—´ã€‚å› æ­¤ï¼Œè¿™ä¸¤ä¸ªé€‰é¡¹ä»…å¯¹ä¸æ•°æ®æ¥æ”¶å’Œå‘é€ç›¸å…³çš„socketä¸“ç”¨ç³»ç»Ÿè°ƒç”¨</p><p>è¿™äº›ç³»ç»Ÿè°ƒç”¨åŒ…æ‹¬sendã€sendmsgã€recvã€recvmsgã€acceptå’Œconnectã€‚</p><p><img alt="image-20210910105841968" src="/assets/images/image-20210910105841968-e523e8b9196c77f63bb108ea53e678ae.png"></p><p>æˆ‘ä»¬å¯ä»¥æ ¹æ®ç³»ç»Ÿè°ƒç”¨ï¼ˆsendã€sendmsgã€recvã€recvmsgã€acceptå’Œconnectï¼‰çš„è¿”å›å€¼ä»¥åŠerrnoæ¥åˆ¤æ–­è¶…æ—¶æ—¶é—´æ˜¯å¦å·²åˆ°ï¼Œè¿›è€Œå†³å®šæ˜¯å¦å¼€å§‹å¤„ç†å®šæ—¶ä»»åŠ¡ã€‚</p><p>å®šæ—¶å™¨ï¼Œè¿™æ˜¯è¡Œä¸šå†…å¸¸ç”¨çš„å«æ³•ã€‚å®é™…ä¸Šï¼Œå…¶ç¡®åˆ‡çš„å«æ³•æ˜¯å®šæ—¶å™¨å®¹å™¨ã€‚</p><p>å®šæ—¶å™¨å®¹å™¨æ˜¯å®¹å™¨ç±»æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚æ—¶é—´è½®ï¼›å®šæ—¶å™¨åˆ™æ˜¯å®¹å™¨å†…å®¹çº³çš„ä¸€ä¸ªä¸ªå¯¹è±¡ï¼Œå®ƒæ˜¯å¯¹å®šæ—¶äº‹ä»¶çš„å°è£…ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="sigalrmä¿¡å·"></a>SIGALRMä¿¡å·<a class="hash-link" href="#sigalrmä¿¡å·" title="Direct link to heading">#</a></h3><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ioå¤ç”¨ç³»ç»Ÿè°ƒç”¨çš„è¶…æ—¶å‚æ•°"></a>I/Oå¤ç”¨ç³»ç»Ÿè°ƒç”¨çš„è¶…æ—¶å‚æ•°<a class="hash-link" href="#ioå¤ç”¨ç³»ç»Ÿè°ƒç”¨çš„è¶…æ—¶å‚æ•°" title="Direct link to heading">#</a></h3><p>Linuxä¸‹çš„3ç»„I/Oå¤ç”¨ç³»ç»Ÿè°ƒç”¨éƒ½å¸¦æœ‰è¶…æ—¶å‚æ•°ï¼Œå› æ­¤å®ƒä»¬ä¸ä»…èƒ½ç»Ÿä¸€å¤„ç†ä¿¡å·å’ŒI/Oäº‹ä»¶ï¼Œä¹Ÿèƒ½ç»Ÿä¸€å¤„ç†å®šæ—¶äº‹ä»¶ã€‚ä½†æ˜¯ç”±äºI/Oå¤ç”¨ç³»ç»Ÿè°ƒç”¨å¯èƒ½åœ¨è¶…æ—¶æ—¶é—´åˆ°æœŸä¹‹å‰å°±è¿”å›ï¼ˆæœ‰I/Oäº‹ä»¶å‘ç”Ÿï¼‰ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬è¦åˆ©ç”¨å®ƒä»¬æ¥å®šæ—¶ï¼Œå°±éœ€è¦ä¸æ–­æ›´æ–°å®šæ—¶å‚æ•°ä»¥åæ˜ å‰©ä½™çš„æ—¶é—´ï¼Œå¦‚ä»£ç æ¸…å•11-4æ‰€ç¤ºã€‚</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/worst0/wiki_note/edit/main/docs/7.Server/C1.ç½‘ç»œç¼–ç¨‹.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/Server/B1.Linuxå¤šçº¿ç¨‹muduo"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« C++å¤šçº¿ç¨‹ç³»ç»Ÿç¼–ç¨‹</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/Server/D1.å¤šè¿›ç¨‹ç¼–ç¨‹"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">D1.å¤šè¿›ç¨‹ç¼–ç¨‹ Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#ç¬¬5ç« -linuxç½‘ç»œç¼–ç¨‹åŸºç¡€api" class="table-of-contents__link">ç¬¬5ç«  Linuxç½‘ç»œç¼–ç¨‹åŸºç¡€API</a><ul><li><a href="#socketåœ°å€api" class="table-of-contents__link">socketåœ°å€API</a></li><li><a href="#åˆ›å»ºsocketæŒ‡å®šäº†åœ°å€æ—" class="table-of-contents__link">åˆ›å»ºsocket:æŒ‡å®šäº†åœ°å€æ—</a></li><li><a href="#å‘½åsocketæŒ‡å®šsocketåœ°å€" class="table-of-contents__link">å‘½åsocket:æŒ‡å®šsocketåœ°å€</a></li><li><a href="#ç›‘å¬socket" class="table-of-contents__link">ç›‘å¬socket</a></li><li><a href="#æ¥å—è¿æ¥" class="table-of-contents__link">æ¥å—è¿æ¥</a></li><li><a href="#å…³é—­è¿æ¥" class="table-of-contents__link">å…³é—­è¿æ¥</a></li><li><a href="#æ•°æ®è¯»å†™" class="table-of-contents__link">æ•°æ®è¯»å†™</a></li><li><a href="#å¸¦å¤–æ ‡è®°" class="table-of-contents__link">å¸¦å¤–æ ‡è®°</a></li><li><a href="#åœ°å€ä¿¡æ¯å‡½æ•°" class="table-of-contents__link">åœ°å€ä¿¡æ¯å‡½æ•°</a></li><li><a href="#socketé€‰é¡¹" class="table-of-contents__link">socketé€‰é¡¹</a></li><li><a href="#ç½‘ç»œä¿¡æ¯api" class="table-of-contents__link">ç½‘ç»œä¿¡æ¯API</a></li></ul></li><li><a href="#ç¬¬9ç« -ioå¤ç”¨" class="table-of-contents__link">ç¬¬9ç«  I/Oå¤ç”¨</a><ul><li><a href="#selectç³»ç»Ÿè°ƒç”¨" class="table-of-contents__link">selectç³»ç»Ÿè°ƒç”¨</a></li><li><a href="#pollç³»ç»Ÿè°ƒç”¨" class="table-of-contents__link">pollç³»ç»Ÿè°ƒç”¨</a></li><li><a href="#epollç³»åˆ—ç³»ç»Ÿè°ƒç”¨" class="table-of-contents__link">epollç³»åˆ—ç³»ç»Ÿè°ƒç”¨</a></li><li><a href="#ä¸‰ç»„ioå¤ç”¨å‡½æ•°çš„æ¯”è¾ƒ" class="table-of-contents__link">ä¸‰ç»„I/Oå¤ç”¨å‡½æ•°çš„æ¯”è¾ƒ</a></li></ul></li><li><a href="#ç¬¬10ç« -ä¿¡å·" class="table-of-contents__link">ç¬¬10ç«  ä¿¡å·</a><ul><li><a href="#linuxä¿¡å·æ¦‚è¿°" class="table-of-contents__link">Linuxä¿¡å·æ¦‚è¿°</a></li><li><a href="#ä¿¡å·å‡½æ•°" class="table-of-contents__link">ä¿¡å·å‡½æ•°</a></li><li><a href="#ä¿¡å·é›†" class="table-of-contents__link">ä¿¡å·é›†</a></li><li><a href="#ç»Ÿä¸€äº‹ä»¶æº" class="table-of-contents__link">ç»Ÿä¸€äº‹ä»¶æº</a></li><li><a href="#ç½‘ç»œç¼–ç¨‹ç›¸å…³ä¿¡å·" class="table-of-contents__link">ç½‘ç»œç¼–ç¨‹ç›¸å…³ä¿¡å·</a></li></ul></li><li><a href="#ç¬¬11ç« -å®šæ—¶å™¨" class="table-of-contents__link">ç¬¬11ç«  å®šæ—¶å™¨</a><ul><li><a href="#socketé€‰é¡¹so_rcvtimeoå’Œso_sndtimeo" class="table-of-contents__link">socketé€‰é¡¹SO_RCVTIMEOå’ŒSO_SNDTIMEO</a></li><li><a href="#sigalrmä¿¡å·" class="table-of-contents__link">SIGALRMä¿¡å·</a></li><li><a href="#ioå¤ç”¨ç³»ç»Ÿè°ƒç”¨çš„è¶…æ—¶å‚æ•°" class="table-of-contents__link">I/Oå¤ç”¨ç³»ç»Ÿè°ƒç”¨çš„è¶…æ—¶å‚æ•°</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.e07295d6.js"></script>
<script src="/assets/js/main.acc1624b.js"></script>
</body>
</html>